{% extends 'checksheet/base.html' %}
{% block title %}Add Parameter{% endblock %}
{% block content %}
<style>
    /* Page container */
    .page-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 0 16px;
    }
    option {
        background: #1e293b;
    }
    body.white-mode option {
        background: white;
        color: var(--text-light)
    }
    
    /* Header */
    .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.3rem 0;
        margin-bottom: 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .page-title {
        color: var(--text-light);
        font-size: 1.25rem;
        font-weight: 600;
    }
    
    .back-button {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 32px;
        height: 32px;
        border-radius: 6px;
        background-color: rgba(255, 255, 255, 0.1);
        color: rgba(255, 255, 255, 0.7);
        border: none;
        cursor: pointer;
        transition: all 0.2s;
    }
    body.white-mode .back-button {
        background-color: #f1f5f9;
        color: #64748b;
    }
    .back-button:hover {
        background-color: rgba(255, 255, 255, 0.2);
        color: #ffffff;
    }
    body.white-mode .back-button:hover {
        background-color: #e2e8f0;
        color: #334155;
    }
    
    /* Form container */
    .form-container {
        
        border-radius: 8px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        padding: 20px;
    }
    body.white-mode .form-container {
        box-shadow: 0 4px 10px rgb(0 0 0 / 25%);
    }
    /* Form layout */
    .form-layout {
        display: grid;
        grid-template-columns: 1fr;
        gap: 20px;
    }
    
    /* Form inputs */
    .form-inputs {
        display: flex;
        flex-direction: column;
        gap: 20px;
    }
    
    /* Form group styling */
    .form-group {
        margin-bottom: 0;
    }
    
    .form-label {
        display: block;
        font-weight: 500;
        margin-bottom: 6px;
        color: var(--text-light);
        font-size: 0.875rem;
    }
    
    /* Input styling */
    .form-input {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid rgb(161 161 161 / 82%);
        border-radius: 8px;
        font-size: 0.875rem;
        color: #ffffff;
        background-color: rgba(255, 255, 255, 0.1);
        transition: all 0.2s;
        height: 36px;
        box-sizing: border-box;
    }
    
    .form-input:focus {
        outline: none;
        border-color: var(--accent-color);
        box-shadow: 0 0 0 1px rgba(59, 130, 246, 0.5);
    }
    
    /* Select styling */
    .form-select {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid rgb(161 161 161 / 82%);
        border-radius: 8px;
        font-size: 0.875rem;
        color: var(--text-light);
        background-color: rgba(255, 255, 255, 0.1);
        transition: all 0.2s;
        height: 36px;
        box-sizing: border-box;
        cursor: pointer;
    }
    
    .form-select:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 1px rgba(59, 130, 246, 0.5);
    }
    
    /* File input styling */
    .file-input-container {
        margin-top: 6px;
    }
    
    .file-input {
        display: none;
    }
    
    .file-input-label {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 12px;
        background: rgba(255, 255, 255, 0.05);
        border: 1px dashed rgba(255, 255, 255, 0.2);
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 0.875rem;
        color: rgba(255, 255, 255, 0.7);
        height: 36px;
        box-sizing: border-box;
    }
    body.white-mode .file-input-label {
        border: 1px dashed rgb(161 161 161 / 82%);
        color: var(--text-light);
    }
    .file-input-label:hover {
        border-color: var(--accent-color-solid);
        background: rgba(255, 255, 255, 0.1);
    }
    .file-input-label i {
        color: var(--accent-color-solid);
    }
    /* Parameter info box */
    .parameter-info {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 8px;
        padding: 12px 16px;
        margin-top: 20px;
    }
    
    .parameter-info-title {
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: 500;
        color: #ffffff;
        font-size: 0.875rem;
        margin-bottom: 8px;
    }
    
    .parameter-info-content {
        color: rgba(255, 255, 255, 0.7);
        font-size: 0.8125rem;
        line-height: 1.5;
    }
    
    /* Footer actions */
    .form-actions {
        display: flex;
        justify-content: flex-end;
        margin-top: 20px;
    }
    
    /* Submit button styling */
    .submit-btn {
        background-color: #10b981;
        color: var(--text-light);
        padding: 8px 16px;
        border-radius: 8px;
        font-size: 0.875rem;
        font-weight: 500;
        border: none;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 8px;
        height: 36px;
    }
    body.white-mode .submit-btn {
        background-color: var(--accent-color-solid);
    }
    .submit-btn:hover {
        background-color: #059669;
        transform: translateY(-3px);
        box-shadow: 0 6px 10px rgba(0, 0, 0, 0.15);
    }
    body.white-mode .submit-btn:hover {
        border: 1.5px solid var(--accent-color-solid);
        transform: translateY(-3px);
        box-shadow: 0 6px 10px var(--accent-color);
    }
    
    /* Checkbox container */
    .checkbox-container {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .checkbox-text-container {
        display: none; /* Hidden by default */
    }
    
    /* Success popup */
    .success-popup {
        position: fixed;
        top: 20px;
        right: 20px;
        background: #10b981;
        color: white;
        padding: 15px 25px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        z-index: 1000;
        display: none;
        animation: slideIn 0.3s ease forwards;
        font-size: 0.875rem;
    }
    
    @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
    
    @keyframes slideOut {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
    }
    
    /* Unit selection styling */
    .unit-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 15px;
    }
    
    .custom-select-container {
        position: relative;
        width: 100%;
    }
    
    .custom-select-toggle {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid rgb(161 161 161 / 82%);
        border-radius: 8px;
        font-size: 0.875rem;
        text-align: left;
        background-color: rgba(255, 255, 255, 0.1);
        color: var(--text-light);
        cursor: pointer;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    
    .custom-select-toggle:hover {
        border-color: var(--accent-color);
    }
    
    .custom-select-toggle:after {
        content: '▼';
        font-size: 12px;
        color: rgba(255, 255, 255, 0.7);
    }
    
    .custom-select-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        KPIs: 1fr;
        max-height: 200px;
        overflow-y: auto;
        background-color: #1e293b;
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        z-index: 10;
        display: none;
    }
    
    .custom-select-dropdown.show {
        display: block;
    }
    
    .custom-select-search {
        width: 100%;
        padding: 8px 12px;
        border: none;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        box-sizing: border-box;
        font-size: 0.875rem;
        background-color: rgba(255, 255, 255, 0.05);
        color: var(--text-light);
    }
    body.white-mode .custom-select-search {
      
        background-color: white;
        
    }
    
    .custom-select-options {
        max-height: 150px;
        overflow-y: auto;
    }
    .custom-select-option {
        padding: 8px 12px;
        cursor: pointer;
        transition: background-color 0.2s;
        color: rgba(255, 255, 255, 0.8);
        font-size: 0.875rem;
    }
    body.white-mode .custom-select-option {
        color: var(--text-light);
        background:white;
    }
    .custom-select-option:hover {
        background-color: rgba(255, 255, 255, 0.1);
    }
    .custom-select-option.selected {
        background-color: rgba(59, 130, 246, 0.2);
        color: #3b82f6;
    }
    
    /* Check method textarea styling */
    .check-method-container {
        margin-bottom: 15px;
    }
    
    .check-method-textarea {
        width: 100%;
        height: 80px;
        padding: 8px 12px;
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 8px;
        resize: vertical;
        font-family: inherit;
        font-size: 0.875rem;
        background-color: rgba(255, 255, 255, 0.1);
        color: #ffffff;
        transition: border-color 0.3s;
    }
    body.white-mode .check-method-textarea {
        border: 1.5px solid rgb(161 161 161 / 82%);
        background-color: unset;
        color: var(--text-light);
    }
    .check-method-textarea:focus {
        outline: none;
        border-color: var(--accent-color-solid);
        box-shadow: 0 0 0 1px  var(--accent-color-solid);
    }
    
    /* Responsive design */
    @media (max-width: 768px) {
        .form-layout {
            grid-template-columns: 1fr;
        }
        .unit-row {
            grid-template-columns: 1fr;
            gap: 10px;
        }
    }
    
    /* Hidden class */
    .hidden {
        display: none;
    }
    /* Keep existing styles... */
</style>

<div class="page-container">
    <div class="header">
        <h2 class="page-title">Add Startersheet Parameter</h2>
        <a href="javascript:history.back()" class="back-button">
            <i class="fas fa-times"></i>
        </a>
    </div>

    <div class="form-container">
        <form method="POST" enctype="multipart/form-data">
            {% csrf_token %}
           
            <div class="form-layout">
                <div class="form-inputs">
                    <div class="form-group">
                        <label class="form-label" for="zone_name">Parameter Name</label>
                        <input type="text" id="zone_name" name="zone_name" required
                               class="form-input" placeholder="Enter parameter name">
                    </div>
                   
                    <div class="form-group">
                        <label class="form-label" for="zone_type">Parameter Type</label>
                        <select id="zone_type" name="zone_type" class="form-select" required>
                            <option value="int">Integer</option>
                            <option value="float">Decimal</option>
                            <option value="checkbox">Checkbox</option>
                        </select>
                    </div>
                    <div class="form-group min-max-group">
                        <label class="form-label" for="zone_min">Minimum Value</label>
                        <input type="number" id="zone_min" name="zone_min" class="form-input" placeholder="Enter minimum value">
                    </div>
                   
                    <div class="form-group min-max-group">
                        <label class="form-label" for="zone_max">Maximum Value</label>
                        <input type="number" id="zone_max" name="zone_max" class="form-input" placeholder="Enter maximum value">
                    </div>
                   
                    <div class="checkbox-container">
                        <label class="form-label">Default Value</label>
                        <input type="checkbox" name="zone_default">
                    </div>
                    
                    <!-- New Checkbox Text Input -->
                    <div class="form-group checkbox-text-container">
                        <label class="form-label" for="checkbox_text">Standard</label>
                        <input type="text" id="checkbox_text" name="checkbox_text" 
                               class="form-input" placeholder="Enter text to display for checkbox">
                    </div>

                    <!-- Unit Row - will be hidden for checkboxes -->
                    <div class="unit-row">
                        <div class="unit-select-container">
                            <label class="form-label">Unit</label>
                            <div class="custom-select-container" id="unit-select">
                                <input type="hidden" name="zone_unit" class="custom-select-input" value="">
                                <button type="button" class="custom-select-toggle">Select Unit</button>
                                <div class="custom-select-dropdown">
                                    <input type="text" class="custom-select-search" placeholder="Search units...">
                                    <div class="custom-select-options">
                                        <!-- Options will be populated by JavaScript -->
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="custom-unit-container">
                            <label class="form-label">Custom Unit</label>
                            <input type="text" name="zone_custom_unit" 
                                  class="form-input" placeholder="Or enter custom unit">
                        </div>
                    </div>
                    
                    <!-- Check Method Container -->
                    <div class="check-method-container">
                        <label class="form-label">Check Method</label>
                        <textarea name="zone_check_method" 
                                  class="check-method-textarea" 
                                  placeholder="Enter check method details"></textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Parameter Image</label>
                        <div class="file-input-container">
                            <label class="file-input-label">
                                <i class="fas fa-cloud-upload-alt"></i>
                                <span>Choose image</span>
                                <input type="file" name="zone_image" accept="image/*" class="file-input">
                            </label>
                        </div>
                    </div>
                </div>
            </div>
           
            <div class="parameter-info">
                <div class="parameter-info-title">
                    <i class="fas fa-lightbulb"></i>
                    <span>Quick Tip</span>
                </div>
                <div class="parameter-info-content">
                    Choose a descriptive name for your Parameter and select the appropriate type based on the data you'll be collecting. Integer for whole numbers, Decimal for numbers with decimals, and Checkbox for yes/no values.
                </div>
            </div>
           
            <div class="form-actions">
                <button type="submit" class="submit-btn">
                    <i class="fas fa-plus-circle"></i>
                    Add Parameter
                </button>
            </div>
        </form>
    </div>
</div>

<div id="success-popup" class="success-popup">
    <h3>Parameter Added Successfully!</h3>
</div>

<script>
    const UNITS = ["", "kg", "g", "mg", "l", "ml", "m", "cm", "mm", "km", "m²", "m³", "pascal", "bar", "psi", "N", "kN", "°C", "°F", "A", "V", "W", "kW", "Hz", "rpm", "s", "min", "h", "%"];

    // Function to toggle inputs based on parameter type
    function toggleInputs() {
        const select = document.getElementById('zone_type');
        const minMaxGroups = document.querySelectorAll('.min-max-group');
        const checkboxContainer = document.querySelector('.checkbox-container');
        const unitRow = document.querySelector('.unit-row');
        const checkboxTextContainer = document.querySelector('.checkbox-text-container');
        
        if (select.value === 'checkbox') {
            // For checkbox type
            minMaxGroups.forEach(group => group.classList.add('hidden'));
            checkboxContainer.style.display = 'flex';
            unitRow.style.display = 'none'; // Hide unit row
            checkboxTextContainer.style.display = 'block'; // Show checkbox text input
        } else {
            // For numeric types
            minMaxGroups.forEach(group => group.classList.remove('hidden'));
            checkboxContainer.style.display = 'none';
            unitRow.style.display = 'grid'; // Show unit row with grid display
            checkboxTextContainer.style.display = 'none'; // Hide checkbox text input
        }
    }

    // Initialize custom selects
    function initializeCustomSelects() {
        const container = document.querySelector('.custom-select-container');
        const hiddenInput = container.querySelector('.custom-select-input');
        const toggleButton = container.querySelector('.custom-select-toggle');
        const dropdown = container.querySelector('.custom-select-dropdown');
        const searchInput = container.querySelector('.custom-select-search');
        const optionsContainer = container.querySelector('.custom-select-options');
        
        // Clear existing options
        optionsContainer.innerHTML = '';
        
        // Add the options
        UNITS.forEach(unit => {
            const option = document.createElement("div");
            option.className = "custom-select-option";
            option.textContent = unit || "None";
            option.dataset.value = unit;
            
            option.addEventListener("click", () => {
                // Update the hidden input and toggle button
                hiddenInput.value = unit;
                toggleButton.textContent = unit || "Select Unit";
                
                // Close the dropdown
                dropdown.classList.remove("show");
                
                // Enable/disable custom unit input based on selection
                const customUnitInput = document.querySelector('input[name="zone_custom_unit"]');
                if (customUnitInput) {
                    if (unit) {
                        customUnitInput.disabled = true;
                        customUnitInput.value = '';
                    } else {
                        customUnitInput.disabled = false;
                    }
                }
                
                // Add selected class to this option and remove from others
                optionsContainer.querySelectorAll('.custom-select-option').forEach(opt => {
                    opt.classList.remove('selected');
                });
                option.classList.add('selected');
            });
            
            optionsContainer.appendChild(option);
        });
        
        // Toggle dropdown on button click
        toggleButton.addEventListener("click", (e) => {
            e.preventDefault();
            dropdown.classList.toggle("show");
            if (dropdown.classList.contains("show")) {
                searchInput.focus();
            }
        });
        
        // Filter options based on search input
        searchInput.addEventListener("input", () => {
            const searchTerm = searchInput.value.toLowerCase();
            optionsContainer.querySelectorAll(".custom-select-option").forEach(option => {
                const text = option.textContent.toLowerCase();
                option.style.display = text.includes(searchTerm) ? "block" : "none";
            });
        });
    }
    
    // Function to toggle between dropdown and custom unit
    function setupUnitInputs() {
        const unitSelect = document.querySelector('.custom-select-container');
        const customUnitInput = document.querySelector('input[name="zone_custom_unit"]');
        const unitToggle = unitSelect.querySelector('.custom-select-toggle');
        const hiddenInput = unitSelect.querySelector('.custom-select-input');
        
        // Add click event to the label of custom unit to enable the field
        const customUnitLabel = customUnitInput.closest('.custom-unit-container').querySelector('.form-label');
        
        customUnitLabel.addEventListener('click', function() {
            // Enable the custom unit input even if it was disabled
            customUnitInput.disabled = false;
            customUnitInput.focus(); // Set focus to the input
            
            // Disable the unit dropdown
            unitToggle.disabled = true;
            hiddenInput.value = '';
            unitToggle.textContent = 'Select Unit';
            unitSelect.style.opacity = '0.7';
        });
        
        // Also add click event to the custom unit input container
        customUnitInput.closest('.custom-unit-container').addEventListener('click', function(e) {
            if (e.target !== customUnitInput) { // Avoid duplicate events if clicking directly on input
                // Enable the custom unit input even if it was disabled
                customUnitInput.disabled = false;
                customUnitInput.focus(); // Set focus to the input
                
                // Disable the unit dropdown
                unitToggle.disabled = true;
                hiddenInput.value = '';
                unitToggle.textContent = 'Select Unit';
                unitSelect.style.opacity = '0.7';
            }
        });
        
        // Custom unit input event listener
        customUnitInput.addEventListener('input', function() {
            if (this.value) {
                // If something is typed in custom unit, disable dropdown
                unitToggle.disabled = true;
                hiddenInput.value = '';
                unitToggle.textContent = 'Select Unit';
                unitSelect.style.opacity = '0.7';
            } else {
                // If custom unit is cleared, enable dropdown
                unitToggle.disabled = false;
                unitSelect.style.opacity = '1';
            }
        });
        
        // Unit dropdown selection event
        unitToggle.addEventListener('click', function() {
            if (!this.disabled) {
                // When clicking on the dropdown, disable custom unit
                customUnitInput.disabled = true;
                customUnitInput.value = '';
            }
        });
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize the type input toggle
        toggleInputs();
        
        // Add event listener for type selection change
        document.getElementById('zone_type').addEventListener('change', toggleInputs);
        
        // Initialize custom selects
        initializeCustomSelects();
        
        // Setup unit input relationships
        setupUnitInputs();
        
        // Close dropdowns when clicking outside
        document.addEventListener("click", (event) => {
            const container = document.querySelector('.custom-select-container');
            if (!container.contains(event.target)) {
                container.querySelector('.custom-select-dropdown').classList.remove("show");
            }
        });
    });

    // Show file name when an image is selected
    document.querySelectorAll('.file-input').forEach(input => {
        input.addEventListener('change', function(e) {
            const fileName = e.target.files[0]?.name || 'Choose image';
            this.previousElementSibling.textContent = fileName;
        });
    });

    // Show success popup if the form is submitted successfully
    {% if success %}
        window.onload = function() {
            var successPopup = document.getElementById('success-popup');
            successPopup.style.display = 'block'; // Show the popup
            setTimeout(() => {
                successPopup.style.animation = 'slideOut 0.3s ease forwards';
                setTimeout(() => {
                    successPopup.style.display = 'none';
                    successPopup.style.animation = '';
                }, 300);
            }, 3000);
        };
    {% endif %}
</script>
{% endblock %}