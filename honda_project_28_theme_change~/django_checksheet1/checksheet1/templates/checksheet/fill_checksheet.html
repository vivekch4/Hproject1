{% extends 'checksheet/base.html' %}
{% load static %}
{% block extra_css %}

<link rel="stylesheet" href="{% static 'css/fill_checksheet.css' %}">
{% endblock %}
{% block title %}Fill Checksheet{% endblock %}

<script src="{% static 'js/offline.js' %}"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>

{% block content %}

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>

{% if selected_checksheet %}
<div class="page-container">
    <div class="header">
        <h2 class="page-title">{{ selected_checksheet.name }}</h2>
        <div class="action-buttons">
            <button id="edit-checksheets-btn" class="edit-btn">
                <i class="fas fa-edit"></i> <span data-translate="edit">Edit</span>
            </button>
            <div class="reject-zone">
                <button type="button" class="reject-btn" onclick="handleRejectReason()">
                    <i class="fas fa-times-circle"></i> <span data-translate="reject">Reject</span>
                </button>
            </div>
            <button id="send-acknowledgment-btn" class="ack-btn">
                <i class="fas fa-check"></i> <span data-translate="finish">Finish</span>
            </button>
            <button class="translate-btn" onclick="toggleLanguage()">
                <i class="fas fa-language"></i> <span data-translate="translate_to_hindi">Hindi</span>
            </button>
            <a href="{% if request.user.role == 'quality_incharge' %}{% url 'quality_incharge_dashboard' %}
         {% elif request.user.role == 'shift_incharge' %}{% url 'shift_incharge_dashboard' %}
         {% else %}{% url 'operator_dashboard' %}{% endif %}" class="back-button" title="Close" data-translate-title="close">
                <i class="fas fa-times"></i>
            </a>
        </div>
    </div>

    <div class="checksheet-container">
        <form method="POST" id="checksheet-form">
            {% csrf_token %}
            <input type="hidden" name="line" value="{{ selected_checksheet.line }}">
            <div class="content-layout">
                <div class="images-section">
                    {% with image_count=images|length %}
                    <div class="images-grid" id="images-grid">
                        {% if images %}
                        {% for img in images %}
                        <div class="image-container">
                            <img src="{{ img.image.url }}" alt="Checksheet Image">
                        </div>
                        {% endfor %}
                        {% else %}
                        <div class="no-image">
                            <i class="fas fa-image"></i>
                            <p data-translate="no_images">No images available</p>
                        </div>
                        {% endif %}
                    </div>
                    {% endwith %}
                </div>

                <div class="form-section">
                    <div class="zones-list">
                        {% for zone in zones %}
                        {% if zone.input_type == "checkbox" %}
                        <div class="zone-item" onclick="toggleZone(this)">
                            <label class="zone-label">{{ zone.name }}</label>
                            <input type="checkbox" id="zone_{{ zone.id }}" name="zone_{{ zone.id }}" class="zone-check">
                        </div>
                        {% elif zone.input_type == "int" %}
                        <div class="zone-item">
                            <label class="zone-label" for="zone_{{ zone.id }}">{{ zone.name }}</label>
                            <input type="number" id="zone_{{ zone.id }}" name="zone_{{ zone.id }}" class="zone-input"
                                min="0">
                        </div>
                        {% elif zone.input_type == "float" %}
                        <div class="zone-item">
                            <label class="zone-label" for="zone_{{ zone.id }}">{{ zone.name }}</label>
                            <input type="number" id="zone_{{ zone.id }}" name="zone_{{ zone.id }}" class="zone-input"
                                step="0.01">
                        </div>
                        {% endif %}
                        {% endfor %}
                    </div>

                    <button type="submit" class="form-submit-btn">
                        <i class="fas fa-save"></i>
                        <span data-translate="save">Save</span>
                    </button>
                    <div class="chart-container">
                        <canvas id="barChart"></canvas>
                    </div>
                </div>
            </div>
        </form>

        <div id="reject-reason-modal" class="modal hidden">
            <div class="modal-content">
                <span class="close-btn" onclick="closeRejectReasonModal()">×</span>
                <h3><i class="fas fa-exclamation-circle"></i> <span data-translate="select_rejection_details">Select Rejection Details</span></h3>
                <select id="reject-reason-select">
                    <option value="" data-translate="select_reason">Select Reason</option>
                    <option value="damaged" data-translate="damaged">Damaged</option>
                    <option value="paint_error" data-translate="paint_error">Paint Error</option>
                    <option value="not_good" data-translate="not_good">Not Good</option>
                </select>
                <select id="reject-zone-select">
                    <option value="" data-translate="select_zone">Select Zone</option>
                    {% for zone in zones %}
                    <option value="{{ zone.name }}">{{ zone.name }}</option>
                    {% endfor %}
                </select>
                <button onclick="saveRejectReason()" data-translate="save_selection">Save Selection</button>
            </div>
        </div>

        <div class="success-popup" id="success-popup">
            <i class="fas fa-check-circle"></i>
            <h3 data-translate="success">Success!</h3>
            <p data-translate="form_submitted">Form submitted successfully</p>
            <button onclick="closeSuccessPopup()" data-translate="ok">OK</button>
        </div>
    </div>
</div>

<div id="checksheets-table" class="hidden">
    <div class="page-container">
        <div class="header">
            <h2 class="page-title" data-translate="todays_checksheets">Today's Submitted Checksheets</h2>
            <button id="back-btn" class="back-button" title="Close" data-translate-title="close">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <div class="form-container">
            <table>
                <thead>
                    <tr>
                        <th data-translate="id">ID</th>
                        <th data-translate="status_data">Status Data</th>
                        <th data-translate="timestamp">Timestamp</th>
                        <th data-translate="action">Action</th>
                    </tr>
                </thead>
                <tbody id="checksheets-body">
                </tbody>
            </table>
        </div>
    </div>
</div>

<div id="alert-popup" class="alert-popup hidden">
    <div class="alert-content">
        <i class="fas fa-exclamation-circle"></i>
        <h3 data-translate="required">Required</h3>
        <p data-translate="select_reason_and_zone">Please select both a reason and a zone for rejection</p>
        <button onclick="closeAlertPopup()" data-translate="ok">OK</button>
    </div>
</div>

<div id="shift-alert-popup" class="alert-popup hidden">
    <div class="alert-content">
        <i class="fas fa-exclamation-circle"></i>
        <h3 data-translate="shift_required">Shift Required</h3>
        <p data-translate="select_shift">Please select a shift before submitting</p>
        <button onclick="closeShiftAlertPopup()" data-translate="ok">OK</button>
    </div>
</div>

<div id="ack-success-popup" class="alert-popup hidden">
    <div class="alert-content">
        <i class="fas fa-check-circle" style="color: white;"></i>
        <h3 data-translate="success">Success</h3>
        <p data-translate="ack_sent">Acknowledgment sent successfully</p>
        <button onclick="closeAckPopup()" style="background: white;" data-translate="ok">OK</button>
    </div>
</div>

<div id="ack-error-popup" class="alert-popup hidden">
    <div class="alert-content">
        <i class="fas fa-exclamation-circle"></i>
        <h3 data-translate="error">Error</h3>
        <p data-translate="ack_failed">Failed to send acknowledgment</p>
        <button onclick="closeAckPopup()" data-translate="ok">OK</button>
    </div>
</div>

<div id="zone-alert-popup" class="alert-popup hidden">
    <div class="alert-content">
        <i class="fas fa-exclamation-circle"></i>
        <h3 data-translate="zone_required">Zone Required</h3>
        <p data-translate="select_one_zone">Please select at least one zone before submitting</p>
        <button onclick="closeZoneAlertPopup()" data-translate="ok">OK</button>
    </div>
</div>

<script>
    document.body.classList.add('fill-checksheet');
    function getCsrfToken() {
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
        if (!csrfToken) {
            console.warn('CSRF token not found in DOM, fetching from server...');
            return fetch('/get-csrf-token/', {
                method: 'GET',
                credentials: 'same-origin'
            })
            .then(response => response.json())
            .then(data => data.csrfToken)
            .catch(error => {
                console.error('Error fetching CSRF token:', error);
                return null;
            });
        }
        return Promise.resolve(csrfToken);
    }
    // Offline utilities (unchanged)
   // Offline utilities
function isOnline() {
    return navigator.onLine;
}

function generateUniqueId() {
    return 'offline_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
}
   
function saveFormDataLocally(formData) {
    const formDataObj = {};
    formData.forEach((value, key) => {
        formDataObj[key] = value;
    });

    formDataObj.id = generateUniqueId();
    formDataObj.timestamp = new Date().toISOString();

    let offlineSubmissions = JSON.parse(localStorage.getItem('offlineSubmissions') || '[]');
    offlineSubmissions.push(formDataObj);
    localStorage.setItem('offlineSubmissions', JSON.stringify(offlineSubmissions));

    console.log('Form data saved to localStorage:', formDataObj);
}

async function syncOfflineSubmissions() {
    let offlineSubmissions = JSON.parse(localStorage.getItem('offlineSubmissions') || '[]');
    if (offlineSubmissions.length === 0) {
        console.log('No offline submissions to sync.');
        return;
    }

    console.log('Attempting to sync offline submissions:', offlineSubmissions);

    let successfulSyncs = 0;
    const totalSubmissions = offlineSubmissions.length;
    const newOfflineSubmissions = [...offlineSubmissions];

    // Get CSRF token before syncing
    const csrfToken = await getCsrfToken();
    if (!csrfToken) {
        console.error('Cannot sync: CSRF token unavailable');
        return;
    }

    const syncPromises = offlineSubmissions.map((submission, index) => {
        const formData = new FormData();
        Object.entries(submission).forEach(([key, value]) => {
            if (key !== 'id' && key !== 'timestamp') {
                formData.append(key, value);
            }
        });

        return fetch(window.location.href, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': csrfToken
            },
            credentials: 'same-origin'
        })
        .then(response => {
            if (response.ok) {
                console.log(`Successfully synced submission ${submission.id}`);
                successfulSyncs++;
                newOfflineSubmissions[index] = null;
            } else {
                console.error(`Failed to sync submission ${submission.id}`);
            }
        })
        .catch(error => {
            console.error(`Error syncing submission ${submission.id}:`, error);
        });
    });

    Promise.all(syncPromises).then(() => {
        const remainingSubmissions = newOfflineSubmissions.filter(submission => submission !== null);
        localStorage.setItem('offlineSubmissions', JSON.stringify(remainingSubmissions));

        if (successfulSyncs > 0) {
            showSyncSuccessMessage(successfulSyncs);
        }
    });
}

function showSyncSuccessMessage(count) {
    const popup = document.createElement('div');
    popup.className = 'alert-popup';
    popup.innerHTML = `
        <div class="alert-content">
            <i class="fas fa-check-circle"></i>
            <h3>Sync Success</h3>
            <p>${count} offline submission${count > 1 ? 's have' : ' has'} been synced to the server.</p>
            <button onclick="this.parentElement.parentElement.remove()">OK</button>
        </div>
    `;
    document.body.appendChild(popup);
    popup.style.display = 'block';
}

function showOfflineSaveMessage() {
    const popup = document.createElement('div');
    popup.className = 'alert-popup';
    popup.innerHTML = `
        <div class="alert-content">
            <i class="fas fa-info-circle"></i>
            <h3>Offline Mode</h3>
            <p>Your submission has been saved locally and will sync when internet is available.</p>
            <button onclick="this.parentElement.parentElement.remove()">OK</button>
        </div>
    `;
    document.body.appendChild(popup);
    popup.style.display = 'block';
}

window.addEventListener('online', () => {
    console.log('Internet connection restored. Attempting to sync offline submissions...');
    syncOfflineSubmissions();
});

window.addEventListener('offline', () => {
    console.log('Internet connection lost. Submissions will be saved locally.');
});
   
window.offlineUtils = {
    isOnline,
    saveFormDataLocally,
    syncOfflineSubmissions,
    showOfflineSaveMessage
};
    // Shift data and related functions (unchanged)
    let shiftData = {
        shiftATimes: { start: null, end: null },
        shiftBTimes: { start: null, end: null },
        currentShift: null,
        currentDay: null,
        logoutScheduled: false
    };
   
    document.addEventListener('DOMContentLoaded', function() {
        syncWithServer().then(() => {
            initializeScheduledEvents();
        });
   
        const currentShiftElement = document.getElementById('current-shift-data');
        let currentShift = "{{ current_shift|default:'None' }}";
   
        if (currentShiftElement) {
            currentShift = currentShiftElement.dataset.value;
        }
   
        console.log("Current shift:", currentShift);
   
        const navbar = document.querySelector('.navbar');
        if (navbar) {
            const navbarLeft = navbar.querySelector('.navbar-left');
            const logoutBtn = navbar.querySelector('.logout-btn');
   
            const navbarCenter = document.createElement('div');
            navbarCenter.className = 'navbar-center';
            navbarCenter.innerHTML = `
                <span class="datetime-display"><i class="fas fa-calendar-alt"></i> <span id="current-datetime"></span></span>
                <span class="shift-label"><i class="fas fa-clock"></i> ${translations[currentLanguage].current_shift} ${currentShift}</span>
                <span class="shift-countdown-alert hidden" id="shift-countdown"><i class="fas fa-hourglass-half"></i> ${translations[currentLanguage].shift_ending_in} <span id="countdown-timer">02:00</span></span>
            `;
   
            if (logoutBtn) {
                navbar.insertBefore(navbarCenter, logoutBtn);
            } else {
                navbar.appendChild(navbarCenter);
            }
            updateDateTime();
        }
   
        if (currentShift === "None") {
            document.getElementById('shift-alert-popup').style.display = 'block';
        }
   
        function updateDateTime() {
            const now = new Date();
            const dateOptions = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            const timeOptions = { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true };
   
            const dateStr = now.toLocaleDateString(undefined, dateOptions);
            const timeStr = now.toLocaleTimeString(undefined, timeOptions);
   
            document.getElementById('current-datetime').textContent = `${dateStr} ${timeStr}`;
   
            setTimeout(updateDateTime, 1000);
        }
   
        const imagesGrid = document.getElementById('images-grid');
        if (imagesGrid) {
            const imageCount = imagesGrid.querySelectorAll('.image-container').length;
            imagesGrid.classList.remove('one-image', 'two-images', 'three-images', 'four-images');
            if (imageCount === 1) imagesGrid.classList.add('one-image');
            else if (imageCount === 2) imagesGrid.classList.add('two-images');
            else if (imageCount === 3) imagesGrid.classList.add('three-images');
            else if (imageCount >= 4) imagesGrid.classList.add('four-images');
        }
   
        const editCheckBtn = document.getElementById('edit-checksheets-btn');
        const checksheetContainer = document.querySelector('.checksheet-container');
        const checksheetsTable = document.getElementById('checksheets-table');
        const backBtn = document.getElementById('back-btn');
        const selectedChecksheetId = "{{ selected_checksheet.id }}";
   
        if (editCheckBtn) {
            editCheckBtn.addEventListener('click', function () {
                checksheetContainer.classList.add('hidden');
                checksheetsTable.classList.remove('hidden');
                editCheckBtn.classList.add('hidden');
   
                fetch(`/get_today_checksheets/?checksheet_id=${selectedChecksheetId}&checksheet_name=${encodeURIComponent('{{ selected_checksheet.name }}')}&line=${encodeURIComponent('{{ selected_checksheet.line }}')}&shift=${encodeURIComponent('{{ current_shift }}')}`)
                    .then(response => response.json())
                    .then(data => {
                        let tableBody = document.getElementById('checksheets-body');
                        tableBody.innerHTML = "";
   
                        if (data.length === 0) {
                            tableBody.innerHTML = `<tr><td colspan='4'>${translations[currentLanguage].no_data}</td></tr>`;
                        } else {
                            data.forEach(checksheet => {
                                let statusText = Object.entries(checksheet.status_data)
                                    .map(([key, value]) => `${key}: ${value}`)
                                    .join(", ");
   
                                let row = `<tr id="row-${checksheet.id}">
                                    <td>${checksheet.id}</td>
                                    <td>${statusText}</td>
                                    <td>${new Date(checksheet.timestamp).toLocaleString()}</td>
                                    <td>
                                        <button class="delete-entry" data-id="${checksheet.id}">
                                            ${translations[currentLanguage].delete}
                                        </button>
                                    </td>
                                </tr>`;
                                tableBody.innerHTML += row;
                            });
                        }
                    })
                    .catch(error => console.error("Error fetching data:", error));
            });
        }
   
        if (backBtn) {
            backBtn.addEventListener('click', function () {
                checksheetContainer.classList.remove('hidden');
                checksheetsTable.classList.add('hidden');
                editCheckBtn.classList.remove('hidden');
            });
        }
   
        document.addEventListener('click', function (event) {
            if (event.target.classList.contains('delete-entry')) {
                const entryId = event.target.getAttribute('data-id');
   
                fetch(`/delete_checksheet/${entryId}/`, {
                    method: 'DELETE',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}',
                        'Content-Type': 'application/json'
                    }
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            document.getElementById(`row-${entryId}`).remove();
                        } else {
                            alert(translations[currentLanguage].delete_error);
                        }
                    })
                    .catch(error => console.error("Error deleting entry:", error));
            }
        });
   
        window.toggleZone = function (element) {
            const checkbox = element.querySelector('.zone-check');
            if (checkbox) {
                checkbox.checked = !checkbox.checked;
                element.classList.toggle('selected', checkbox.checked);
            }
        };
   
        const numberInputs = document.querySelectorAll('.zone-item input[type="number"]');
        numberInputs.forEach(input => {
            const zoneItem = input.closest('.zone-item');
   
            input.addEventListener('input', () => {
                if (input.value) {
                    zoneItem.classList.add('selected');
                } else {
                    zoneItem.classList.remove('selected');
                }
            });
        });
   
        function isAnyZoneSelected() {
            const checkboxZones = document.querySelectorAll('.zone-check:checked');
            const numberZones = document.querySelectorAll('.zone-input');
   
            for (let input of numberZones) {
                if (input.value && input.value.trim() !== '') {
                    return true;
                }
            }
   
            return checkboxZones.length > 0;
        }
   
        document.getElementById('checksheet-form').addEventListener('submit', async function (e) {
            e.preventDefault();
        
            const rejectReason = document.getElementById('reject_reason');
        
            if (!rejectReason || !rejectReason.value) {
                if (!isAnyZoneSelected()) {
                    document.getElementById('zone-alert-popup').style.display = 'block';
                    return;
                }
            }
        
            const formData = new FormData(this);
            formData.append('shift', "{{ current_shift }}");
        
            if (offlineUtils.isOnline()) {
                const csrfToken = await getCsrfToken();
                if (!csrfToken) {
                    console.error('Cannot submit: CSRF token unavailable');
                    offlineUtils.saveFormDataLocally(formData);
                    offlineUtils.showOfflineSaveMessage();
                    this.reset();
                    document.querySelectorAll('.zone-item').forEach(zone => {
                        zone.classList.remove('selected');
                    });
                    return;
                }
        
                fetch(window.location.href, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': csrfToken
                    },
                    credentials: 'same-origin'
                })
                .then(response => {
                    if (response.ok) {
                        document.getElementById('success-popup').style.display = 'block';
                        this.reset();
                        document.querySelectorAll('.zone-item').forEach(zone => {
                            zone.classList.remove('selected');
                        });
                        offlineUtils.syncOfflineSubmissions();
                    } else {
                        return response.text().then(text => {
                            console.error('Error:', text);
                            throw new Error('Form submission failed: ' + response.status);
                        });
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    offlineUtils.saveFormDataLocally(formData);
                    offlineUtils.showOfflineSaveMessage();
                    this.reset();
                    document.querySelectorAll('.zone-item').forEach(zone => {
                        zone.classList.remove('selected');
                    });
                });
            } else {
                offlineUtils.saveFormDataLocally(formData);
                offlineUtils.showOfflineSaveMessage();
                this.reset();
                document.querySelectorAll('.zone-item').forEach(zone => {
                    zone.classList.remove('selected');
                });
            }
        });
   
        document.getElementById('send-acknowledgment-btn').addEventListener('click', function () {
            fetch('/send_acknowledgments/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    checksheet_id: '{{ selected_checksheet.id }}',
                    shift: "{{ current_shift }}"
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('ack-success-popup').style.display = 'block';
                } else {
                    document.getElementById('ack-error-popup').style.display = 'block';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('ack-error-popup').style.display = 'block';
            });
        });
   
        // Back button confirmation popup
        const backButton = document.querySelector('a.back-button[data-translate-title="close"]');
if (backButton) {
    backButton.addEventListener('click', function (e) {
        e.preventDefault();
        showBackConfirmationPopup(this.getAttribute('href'));
    });
}
    });
   
    // Back confirmation popup
    function showBackConfirmationPopup(redirectUrl) {
        const popup = document.createElement('div');
        popup.className = 'alert-popup';
        popup.id = 'back-confirmation-popup';
        popup.innerHTML = `
            <div class="alert-content">
                <span class="close-btn" onclick="closeBackConfirmationPopup()">×</span>
                <i class="fas fa-question-circle"></i>
                <h3 data-translate="confirmation">Confirmation</h3>
                <p data-translate="send_acknowledgment">Do you want to send acknowledgment?</p>
                <div class="popup-buttons">
                    <button onclick="triggerAcknowledgmentAndRedirect('${redirectUrl}')">${translations[currentLanguage].yes}</button>
                    <button onclick="redirectWithoutAcknowledgment('${redirectUrl}')">${translations[currentLanguage].no}</button>
                </div>
            </div>
        `;
        document.body.appendChild(popup);
        popup.style.display = 'block';
    }
   
    window.closeBackConfirmationPopup = function () {
        const popup = document.getElementById('back-confirmation-popup');
        if (popup) {
            popup.remove();
        }
    };
   
    window.triggerAcknowledgmentAndRedirect = function (redirectUrl) {
        const finishButton = document.getElementById('send-acknowledgment-btn');
        if (finishButton) {
            finishButton.click();
        }
        setTimeout(() => {
            window.location.href = redirectUrl;
        }, 1000); // Wait for acknowledgment to process
        closeBackConfirmationPopup();
    };
   
    window.redirectWithoutAcknowledgment = function (redirectUrl) {
        window.location.href = redirectUrl;
        closeBackConfirmationPopup();
    };
   
    // Shift-related functions (unchanged)
    async function syncWithServer() {
        try {
            const response = await fetch('/get-shift-data/', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            });
   
            const data = await response.json();
            console.log("Server data:", data);
   
            if (data.shift_times) {
                shiftData.shiftATimes = {
                    start: data.shift_times.shift_a_start,
                    end: data.shift_times.shift_a_end
                };
   
                shiftData.shiftBTimes = {
                    start: data.shift_times.shift_b_start,
                    end: data.shift_times.shift_b_end
                };
   
                shiftData.currentShift = data.current_shift;
                shiftData.currentDay = new Date().toDateString();
   
                updateShiftUI(data.current_shift);
            }
   
            return data;
        } catch (error) {
            console.error('Error getting shift data from server:', error);
        }
    }
   
    function initializeScheduledEvents() {
        const now = new Date();
        startCountdown();
   
        const shiftAEndTime = new Date(now);
        if (shiftData.shiftATimes && shiftData.shiftATimes.end) {
            const [aEndHours, aEndMinutes] = shiftData.shiftATimes.end.split(':').map(num => parseInt(num));
            shiftAEndTime.setHours(aEndHours, aEndMinutes, 0, 0);
            if (shiftAEndTime < now) {
                shiftAEndTime.setDate(shiftAEndTime.getDate() + 1);
            }
   
            if (shiftAEndTime > now) {
                const msUntilShiftAEnd = shiftAEndTime - now;
                console.log(`Scheduling shift A->B transition in ${msUntilShiftAEnd/1000/60} minutes`);
   
                setTimeout(() => {
                    if (shiftData.currentShift === 'A') {
                        handleShiftTransition('A', 'B');
                    } else {
                        shiftData.currentShift = 'B';
                        updateShiftUI('B');
                        startCountdown();
                    }
                }, msUntilShiftAEnd);
            }
        }
   
        const shiftBEndTime = new Date(now);
        if (shiftData.shiftBTimes && shiftData.shiftBTimes.end) {
            const [bEndHours, bEndMinutes] = shiftData.shiftBTimes.end.split(':').map(num => parseInt(num));
            shiftBEndTime.setHours(bEndHours, bEndMinutes, 0, 0);
            if (shiftBEndTime < now) {
                shiftBEndTime.setDate(shiftBEndTime.getDate() + 1);
            }
   
            if (shiftBEndTime > now) {
                const msUntilShiftBEnd = shiftBEndTime - now;
                console.log(`Scheduling shift B end in ${msUntilShiftBEnd/1000/60} minutes`);
   
                setTimeout(() => {
                    if (shiftData.currentShift === 'B') {
                        handleShiftEnd();
                    }
                }, msUntilShiftBEnd);
            }
        }
   
        const shiftAStartTime = new Date(now);
        if (shiftData.shiftATimes && shiftData.shiftATimes.start) {
            const [aStartHours, aStartMinutes] = shiftData.shiftATimes.start.split(':').map(num => parseInt(num));
            shiftAStartTime.setHours(aStartHours, aStartMinutes, 0, 0);
            if (shiftAStartTime < now) {
                shiftAStartTime.setDate(shiftAStartTime.getDate() + 1);
            }
   
            const msUntilShiftAStart = shiftAStartTime - now;
            console.log(`Scheduling shift A start in ${msUntilShiftAStart/1000/60} minutes`);
   
            setTimeout(() => {
                shiftData.currentShift = 'A';
                updateShiftUI('A');
                startCountdown();
            }, msUntilShiftAStart);
        }
   
        scheduleMidnightReset(now);
    }
   
    function scheduleMidnightReset(date) {
        const tomorrow = new Date(date);
        tomorrow.setDate(tomorrow.getDate() + 1);
        tomorrow.setHours(0, 0, 0, 0);
   
        const msUntilMidnight = tomorrow - date;
   
        console.log(`Scheduling midnight reset in ${msUntilMidnight/1000/60} minutes`);
   
        setTimeout(() => {
            shiftData.currentDay = new Date().toDateString();
            shiftData.logoutScheduled = false;
   
            scheduleShiftTransitions(tomorrow);
            scheduleMidnightReset(tomorrow);
        }, msUntilMidnight);
    }
   
    function handleShiftTransition(fromShift, toShift) {
        console.log(`Handling shift transition from ${fromShift} to ${toShift}`);
   
        stopCountdown();
   
        shiftData.currentShift = toShift;
        updateShiftUI(toShift);
   
        startCountdown();
   
        verifyShiftChange();
    }
   
    function handleShiftEnd() {
        if (shiftData.logoutScheduled) {
            return;
        }
   
        console.log("Handling shift end - logging out");
        shiftData.logoutScheduled = true;
   
        stopCountdown();
   
        verifyShiftChange();
    }
   
    async function verifyShiftChange() {
        try {
            const response = await fetch('/verify-shift-change/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({
                    client_shift: shiftData.currentShift
                })
            });
   
            const data = await response.json();
   
            if (data.should_logout) {
                const finishButton = document.getElementById('send-acknowledgment-btn');
                if (finishButton && !finishButton.disabled) {
                    finishButton.click();
                    finishButton.disabled = true;
   
                    setTimeout(() => {
                        window.location.href = '/logout/';
                    }, 2000);
                } else {
                    window.location.href = '/logout/';
                }
            } else {
                updateShiftUI(data.current_shift);
            }
        } catch (error) {
            console.error('Error verifying shift change:', error);
        }
    }
   
    function updateShiftUI(currentShift) {
        const shiftLabel = document.querySelector('.shift-label');
        const currentShiftElement = document.getElementById('current-shift-data');
   
        if (shiftLabel && currentShift) {
            shiftLabel.innerHTML = `<i class="fas fa-clock"></i> ${translations[currentLanguage].current_shift} ${currentShift}`;
        }
   
        if (currentShiftElement && currentShift) {
            currentShiftElement.dataset.value = currentShift;
        }
    }
   
    function getMsUntilShiftEnd() {
        const now = new Date();
        let shiftEndTime;
   
        if (!shiftData.currentShift) {
            console.log("No current shift defined");
            return null;
        }
   
        if (shiftData.currentShift === 'A' && shiftData.shiftATimes && shiftData.shiftATimes.end) {
            const [endHours, endMinutes] = shiftData.shiftATimes.end.split(':').map(num => parseInt(num));
            shiftEndTime = new Date(now);
            shiftEndTime.setHours(endHours, endMinutes, 0, 0);
            if (shiftEndTime < now) {
                shiftEndTime.setDate(shiftEndTime.getDate() + 1);
            }
        } else if (shiftData.currentShift === 'B' && shiftData.shiftBTimes && shiftData.shiftBTimes.end) {
            const [endHours, endMinutes] = shiftData.shiftBTimes.end.split(':').map(num => parseInt(num));
            shiftEndTime = new Date(now);
            shiftEndTime.setHours(endHours, endMinutes, 0, 0);
            if (shiftEndTime < now) {
                shiftEndTime.setDate(shiftEndTime.getDate() + 1);
            }
        } else {
            console.log("No valid shift or shift end time:", shiftData.currentShift, shiftData);
            return null;
        }
   
        const msUntilEnd = shiftEndTime - now;
        console.log(`Time until shift ${shiftData.currentShift} end: ${msUntilEnd/1000} seconds`);
        return msUntilEnd;
    }
   
    let countdownInterval = null;
   
    function startCountdown() {
        const countdownElement = document.getElementById('shift-countdown');
        const timerElement = document.getElementById('countdown-timer');
   
        if (!countdownElement || !timerElement) {
            console.error("Countdown elements not found");
            return;
        }
   
        if (countdownInterval) {
            clearInterval(countdownInterval);
        }
   
        updateCountdown();
   
        setInterval(updateCountdown, 1000);
   
        console.log("Countdown started");
    }
   
    function updateCountdown() {
        const countdownElement = document.getElementById('shift-countdown');
        const timerElement = document.getElementById('countdown-timer');
   
        if (!countdownElement || !timerElement) {
            return;
        }
   
        const msUntilEnd = getMsUntilShiftEnd();
        if (msUntilEnd === null || msUntilEnd <= 0) {
            console.log("Shift ended or invalid, stopping countdown");
            countdownElement.classList.add('hidden');
            clearInterval(countdownInterval);
            countdownInterval = null;
            return;
        }
   
        if (msUntilEnd <= 120000) {
            countdownElement.classList.remove('hidden');
            const seconds = Math.floor(msUntilEnd / 1000);
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            timerElement.textContent = `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
        } else {
            countdownElement.classList.add('hidden');
        }
    }
   
    function stopCountdown() {
        const countdownElement = document.getElementById('shift-countdown');
        if (countdownElement) {
            countdownElement.classList.add('hidden');
        }
        if (countdownInterval) {
            clearInterval(countdownInterval);
            countdownInterval = null;
        }
        console.log("Countdown stopped");
    }
   
    // Translation dictionary
    const translations = {
        en: {
            edit: "Edit",
            reject: "Reject",
            finish: "Finish",
            translate_to_hindi: "Hindi",
            translate_to_english: "English",
            close: "Close",
            no_images: "No images available",
            save: "Save",
            select_rejection_details: "Select Rejection Details",
            select_reason: "Select Reason",
            damaged: "Damaged",
            paint_error: "Paint Error",
            not_good: "Not Good",
            select_zone: "Select Zone",
            save_selection: "Save Selection",
            success: "Success!",
            form_submitted: "Form submitted successfully",
            ok: "OK",
            todays_checksheets: "Today's Submitted Checksheets",
            id: "ID",
            status_data: "Status Data",
            timestamp: "Timestamp",
            action: "Action",
            required: "Required",
            select_reason_and_zone: "Please select both a reason and a zone for rejection",
            shift_required: "Shift Required",
            select_shift: "Please select a shift before submitting",
            zone_required: "Zone Required",
            select_one_zone: "Please select at least one zone before submitting",
            ack_sent: "Acknowledgment sent successfully",
            ack_failed: "Failed to send acknowledgment",
            zone_performance: "Zone Performance Overview",
            zone_summary: "Zone Summary",
            values: "Values",
            zones: "Zones",
            current_shift: "Current Shift",
            shift_ending_in: "Shift ending in",
            delete: "Delete",
            confirmation: "Confirmation",
            send_acknowledgment: "Do you want to send acknowledgment?",
            yes: "Yes",
            no: "No"
        },
        hi: {
            edit: "संपादित करें",
            reject: "अस्वीकार करें",
            finish: "समाप्त करें",
            translate_to_hindi: "हिंदी ",
            translate_to_english: "अंग्रेजी",
            close: "बंद करें",
            no_images: "कोई चित्र उपलब्ध नहीं",
            save: "सहेजें",
            select_rejection_details: "अस्वीकृति विवरण चुनें",
            select_reason: "कारण चुनें",
            damaged: "क्षतिग्रस्त",
            paint_error: "पेंट त्रुटि",
            not_good: "अच्छा नहीं",
            select_zone: "जोन चुनें",
            save_selection: "चयन सहेजें",
            success: "सफलता!",
            form_submitted: "फॉर्म सफलतापूर्वक जमा किया गया",
            ok: "ठीक है",
            todays_checksheets: "आज की जमा की गई चेकशीट",
            id: "आईडी",
            status_data: "स्थिति डेटा",
            timestamp: "टाइमस्टैम्प",
            action: "कार्रवाई",
            required: "आवश्यक",
            select_reason_and_zone: "कृपया अस्वीकृति के लिए कारण और जोन दोनों चुनें",
            shift_required: "शिफ्ट आवश्यक",
            select_shift: "कृपया जमा करने से पहले एक शिफ्ट चुनें",
            zone_required: "जोन आवश्यक",
            select_one_zone: "कृपया जमा करने से पहले कम से कम एक जोन चुनें",
            ack_sent: "पावती सफलतापूर्वक भेजी गई",
            ack_failed: "पावती भेजने में विफल",
            zone_performance: "जोन प्रदर्शन अवलोकन",
            zone_summary: "जोन सारांश",
            values: "मान",
            zones: "जोन",
            current_shift: "वर्तमान पाली",
            shift_ending_in: "पाली समाप्त हो रही है",
            delete: "हटाएं",
            confirmation: "पुष्टिकरण",
            send_acknowledgment: "क्या आप पावती भेजना चाहते हैं?",
            yes: "हाँ",
            no: "नहीं"
        }
    };
   
    // Current language state
    let currentLanguage = 'en';
   
    // Function to toggle language
    function toggleLanguage() {
        currentLanguage = currentLanguage === 'en' ? 'hi' : 'en';
   
        document.querySelectorAll('[data-translate]').forEach(element => {
            const key = element.getAttribute('data-translate');
            element.textContent = translations[currentLanguage][key];
        });
   
        document.querySelectorAll('[data-translate-title]').forEach(element => {
            const key = element.getAttribute('data-translate-title');
            element.setAttribute('title', translations[currentLanguage][key]);
        });
   
        document.querySelectorAll('#reject-reason-select option').forEach(option => {
            const key = option.getAttribute('data-translate');
            if (key) {
                option.textContent = translations[currentLanguage][key];
            }
        });
   
        const chart = Chart.getChart('barChart');
        if (chart) {
            chart.options.plugins.title.text = translations[currentLanguage].zone_performance;
            chart.data.datasets[0].label = translations[currentLanguage].zone_summary;
            chart.options.scales.y.title.text = translations[currentLanguage].values;
            chart.options.scales.x.title.text = translations[currentLanguage].zones;
            chart.update();
        }
   
        const translateBtn = document.querySelector('.translate-btn span');
        translateBtn.textContent = translations[currentLanguage][currentLanguage === 'en' ? 'translate_to_hindi' : 'translate_to_english'];
   
        const shiftLabel = document.querySelector('.shift-label');
        if (shiftLabel) {
            const currentShift = document.getElementById('current-shift-data')?.dataset.value || "{{ current_shift|default:'None' }}";
            shiftLabel.innerHTML = `<i class="fas fa-clock"></i> ${translations[currentLanguage].current_shift} ${currentShift}`;
        }
   
        const countdownElement = document.getElementById('shift-countdown');
        if (countdownElement && !countdownElement.classList.contains('hidden')) {
            const timerText = document.getElementById('countdown-timer').textContent;
            countdownElement.innerHTML = `<i class="fas fa-hourglass-half"></i> ${translations[currentLanguage].shift_ending_in} <span id="countdown-timer">${timerText}</span>`;
        }
    }
   
    // Popup and form handling functions
    function closeSuccessPopup() {
        document.getElementById('success-popup').style.display = 'none';
        window.location.reload();
    }
   
    window.closeAckPopup = function () {
        document.getElementById('ack-success-popup').style.display = 'none';
        document.getElementById('ack-error-popup').style.display = 'none';
        window.location.href = "{% url 'operator_dashboard' %}";
    };
   
    window.handleRejectReason = function () {
        document.getElementById('reject-reason-modal').style.display = 'block';
    };
   
    window.closeRejectReasonModal = function () {
        document.getElementById('reject-reason-modal').style.display = 'none';
        document.getElementById('reject-reason-select').value = '';
        document.getElementById('reject-zone-select').value = '';
    };
   
    window.saveRejectReason = function () {
        const reason = document.getElementById('reject-reason-select').value;
        const zone = document.getElementById('reject-zone-select').value;
   
        if (!reason || !zone) {
            document.getElementById('alert-popup').style.display = 'block';
            return;
        }
   
        let rejectInput = document.getElementById('reject_reason');
        if (!rejectInput) {
            rejectInput = document.createElement('input');
            rejectInput.type = 'hidden';
            rejectInput.id = 'reject_reason';
            rejectInput.name = 'reject_reason';
            document.getElementById('checksheet-form').appendChild(rejectInput);
        }
        rejectInput.value = `${reason} - Zone ${zone}`;
   
        closeRejectReasonModal();
   
        // Automatically submit the form
        const form = document.getElementById('checksheet-form');
        const formData = new FormData(form);
        formData.append('shift', "{{ current_shift }}");
   
        if (offlineUtils.isOnline()) {
            fetch(window.location.href, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            })
            .then(response => {
                if (response.ok) {
                    document.getElementById('success-popup').style.display = 'block';
                    form.reset();
                    document.querySelectorAll('.zone-item').forEach(zone => {
                        zone.classList.remove('selected');
                    });
                    offlineUtils.syncOfflineSubmissions();
                } else {
                    return response.text().then(text => {
                        console.error('Error:', text);
                        throw new Error('Form submission failed: ' + response.status);
                    });
                }
            })
            .catch(error => {
                console.error('Error:', error);
                offlineUtils.saveFormDataLocally(formData);
                offlineUtils.showOfflineSaveMessage();
                form.reset();
                document.querySelectorAll('.zone-item').forEach(zone => {
                    zone.classList.remove('selected');
                });
            });
        } else {
            offlineUtils.saveFormDataLocally(formData);
            offlineUtils.showOfflineSaveMessage();
            form.reset();
            document.querySelectorAll('.zone-item').forEach(zone => {
                zone.classList.remove('selected');
            });
        }
    };
   
    window.closeAlertPopup = function () {
        document.getElementById('alert-popup').style.display = 'none';
    };
   
    window.closeZoneAlertPopup = function () {
        document.getElementById('zone-alert-popup').style.display = 'none';
    };
   
    window.closeShiftAlertPopup = function () {
        document.getElementById('shift-alert-popup').style.display = 'none';
    };
   
    document.addEventListener('keydown', function (event) {
        if (event.key === 'Escape') {
            closeRejectReasonModal();
            closeAlertPopup();
            closeZoneAlertPopup();
            closeAckPopup();
            closeShiftAlertPopup();
            closeBackConfirmationPopup();
        }
    });
   
    // Chart update function (unchanged except for fixing the layout.padding typo)
    function updateChart(labels, values) {
        const ctx = document.getElementById('barChart').getContext('2d');
        const chart = Chart.getChart('barChart');
        if (chart) {
            chart.data.labels = labels;
            chart.data.datasets[0].data = values;
            chart.options.plugins.title.text = translations[currentLanguage].zone_performance;
            chart.data.datasets[0].label = translations[currentLanguage].zone_summary;
            chart.options.scales.y.title.text = translations[currentLanguage].values;
            chart.options.scales.x.title.text = translations[currentLanguage].zones;
            chart.update();
        } else {
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: translations[currentLanguage].zone_summary,
                        data: values,
                        backgroundColor: [
                            'rgba(59, 130, 246, 0.6)',
                            'rgba(16, 185, 129, 0.6)',
                            'rgba(239, 68, 68, 0.6)',
                            'rgba(245, 158, 11, 0.6)',
                            'rgba(139, 92, 246, 0.6)',
                            'rgba(234, 88, 12, 0.6)',
                            'rgba(34, 197, 94, 0.6)',
                        ],
                        borderColor: [
                            'rgba(59, 130, 246, 1)',
                            'rgba(16, 185, 129, 1)',
                            'rgba(239, 68, 68, 1)',
                            'rgba(245, 158, 11, 1)',
                            'rgba(139, 92, 246, 1)',
                            'rgba(234, 88, 12, 1)',
                            'rgba(34, 197, 94, 1)',
                        ],
                        borderWidth: 1,
                        barPercentage: 0.6,
                        categoryPercentage: 0.7
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                color: '#FFFFFF'
                            }
                        },
                        title: {
                            display: true,
                            text: translations[currentLanguage].zone_performance,
                            color: '#FFFFFF'
                        },
                        datalabels: {
                            anchor: 'end',
                            align: 'top',
                            formatter: Math.round,
                            font: {
                                weight: 'bold'
                            },
                            color: '#FFFFFF',
                            offset: 0,
                            padding: 4
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: translations[currentLanguage].values,
                                color: '#FFFFFF'
                            },
                            ticks: {
                                color: '#FFFFFF'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: translations[currentLanguage].zones,
                                color: '#FFFFFF'
                            },
                            ticks: {
                                color: '#FFFFFF'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        }
                    },
                    layout: {
                        padding: {
                            top: 20
                        }
                    }
                },
                plugins: [ChartDataLabels]
            });
        }
    }

   

    // Initial chart data
    const labels = {{ chart_labels|safe }};
    const values = {{ chart_values|safe }};
    updateChart(labels, values);

   
   
    </script>
{% endif %}
{% endblock %}

