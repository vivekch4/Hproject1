{% extends 'checksheet/base.html' %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<div class="dashboard">
    <!-- Top Row: Stats Cards and Bar Graph -->
    <div class="top-row">
        <div class="line-filter-container">
          
            <select id="lineFilter" class="line-filter-dropdown">
                <option value="all">All Lines</option>
                {% for line in lines_list %}
                <option value="{{ line }}">{{ line }}</option>
                {% endfor %}
            </select>
        </div>
        <!-- Stats Cards -->
        <div class="stats-container">
            <div class="stat-card dark-blue">
                <div class="stat-icon">
                    <i class="fas fa-industry"></i>
                </div>
                <div class="stat-content">
                    <h3>Total Production</h3>
                    <p class="stat-value" id="production-count">Loading...</p>
                </div>
            </div>
           
            <div class="stat-card red">
                <div class="stat-icon">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <div class="stat-content">
                    <h3>Rejected Counts</h3>
                    <p class="stat-value" id="reject-count">Loading...</p>
                    <p class="stat-change neutral">Monthly Rejects</p>
                </div>
            </div>
           
            <div class="stat-card green">
                <div class="stat-icon">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div class="stat-content">
                    <h3>Actual Production</h3>
                    <p class="stat-value" id="actual-production">Loading...</p>
                    <p class="stat-change neutral">Monthly Production</p>
                </div>
            </div>
           
            <div class="stat-card blue">
                <div class="stat-icon">
                    <i class="fas fa-percentage"></i>
                </div>
                <div class="stat-content">
                    <h3>Efficiency %</h3>
                    <p class="stat-value" id="efficiency-percent">Loading...</p>
                    <p class="stat-change neutral"></p>
                </div>
            </div>
            <!-- Pending Cards -->
            <a href="{% url 'acknowledgment_list' %}" class="stat-card orange">
                <div class="stat-icon">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="stat-content">
                    <h3>Pending Checksheets</h3>
                    <p class="stat-value">{{ pending_count }}</p>
                </div>
            </a>
           
            <a href="{% url 'acknowledgment_list' %}" class="stat-card pink">
                <div class="stat-icon">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="stat-content">
                    <h3>Pending Startersheets</h3>
                    <p class="stat-value">{{ startersheet_pending_count }}</p>
                </div>
            </a>
        </div>

        <!-- Bar Graph -->
        <div class="chart-card line-chart">
            <div class="chart-header">
                <h3>Live Production</h3>
            </div>
            <div class="chart-content">
                <canvas id="lineChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Bottom Row: Pie Chart and Line Chart -->
    <div class="bottom-row">
        <div class="chart-card pie-chart">
            <div class="chart-header">
                <h3>Count by Sheet</h3>
                <div class="chart-actions">
                    <select id="pieChartChecksheet" class="chart-dropdown">
                        <option value="">Select Checksheet</option>
                        {{ checksheet_options|safe }}
                    </select>
                    <button class="chart-filter active" data-period="today">Today</button>
                    <button class="chart-filter" data-period="week">Week</button>
                    <button class="chart-filter" data-period="month">Month</button>
                    <button class="chart-filter" data-period="year">Year</button>
                </div>
            </div>
            <div class="chart-content">
                <canvas id="pieChart"></canvas>
                <div id="pieChartNoData" class="no-data-message">Please select a checksheet to view data</div>
            </div>
        </div>
       
        <div class="chart-card bar-graph">
            <div class="chart-header">
                <h3>Checksheet count</h3>
                <div class="chart-actions">
                    <button class="chart-filter active" data-period="today">Today</button>
                    <button class="chart-filter" data-period="week">Week</button>
                    <button class="chart-filter" data-period="month">Month</button>
                    <button class="chart-filter" data-period="year">Year</button>
                </div>
            </div>
            <div class="chart-content">
                <canvas id="barChart"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Chart.js from CDN -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>

<style>
    /* Dashboard Layout */
    .dashboard {
        padding: 1rem;
        display: flex;
        flex-direction: column;
        gap: 1rem;
        width: 100%;
        box-sizing: border-box;
        overflow: hidden;
    }

    /* Top Row: Stats and Bar Graph */
    .top-row {
        display: flex;
        gap: 1rem;
        width: 100%;
    }

    /* Stats Container */
    .stats-container {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1rem;
        width: 50%;
    }

    .content-inner {
        padding: 0.5rem !important;
    }

    .content {
        padding: 0.5rem !important;
    }

    .stat-card {
        border-radius: 0.75rem;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        padding: 1rem;
        display: flex;
        align-items: center;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        position: relative;
        color: white;
        cursor: pointer;
        text-decoration: none;
    }

    .stat-card.dark-blue { background: #11aabb7a; border:1.5px solid #11aabb;}
    .stat-card.red { background: #f05a67ba; border:1.5px solid #f05a67; }
    .stat-card.green { background: #56c080a3; border:1.5px solid #56c080; }
    .stat-card.blue { background: #3498db80; border:1.5px solid #3498db; }
    .stat-card.orange {background: #e67e22ad; border:1.5px solid #e67e22; }
    .stat-card.pink { background: #e73ca399; border:1.5px solid #e73ca3; }

    body.white-mode .stat-card.dark-blue { background: #1abc; border:unset;}
    body.white-mode .stat-card.red { background: #f05a67; border:unset;}
    body.white-mode .stat-card.green { background: #56c080; border:unset; }
    body.white-mode .stat-card.blue { background: #3498db; border:unset;}
    body.white-mode .stat-card.orange { background: #e67e22; border:unset; }
    body.white-mode .stat-card.pink { background: #e73ca3; border:unset;}

    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15);
    }

    .stat-icon {
        width: 40px;
        height: 40px;
        border-radius: 8px;
        background: rgba(255, 255, 255, 0.2);
        display: flex;
        justify-content: center;
        align-items: center;
        margin-right: 0.75rem;
        border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .stat-icon i {
        font-size: 1.2rem;
        color: white;
    }

    .stat-content {
        flex: 1;
    }

    .stat-content h3 {
        color: rgba(255, 255, 255, 0.9);
        font-size: 0.8rem;
        font-weight: 500;
        margin-bottom: 0.3rem;
    }

    .stat-value {
        font-size: 1.2rem;
        font-weight: 700;
        color: white;
        margin-bottom: 0.3rem;
    }

    .stat-change {
        font-size: 0.7rem;
        font-weight: 600;
        color: rgba(255, 255, 255, 0.8);
    }

    /* Bar Graph */
    .bar-graph {
        width: 50%;
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 0.75rem;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        padding: 1rem;
        display: flex;
        flex-direction: column;
    }

    /* Bottom Row: Pie and Line Charts */
    .bottom-row {
        display: flex;
        gap: 1rem;
        width: 100%;
    }

    .pie-chart {
        width: 50%;
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 0.75rem;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        padding: 1rem;
        display: flex;
        flex-direction: column;
    }

    .line-chart {
        width: 50%;
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 0.75rem;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        padding: 1rem;
        display: flex;
        flex-direction: column;
    }

    .chart-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
        border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        padding-bottom: 0.5rem;
        flex-wrap: wrap;
    }

    .chart-header h3 {
        font-size: 1rem;
        font-weight: 600;
        color: #f3f3f3;
    }

    .chart-actions {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
    }

    .chart-dropdown {
        padding: 0.3rem 0.5rem;
        border-radius: 0.5rem;
        color: #f1f1f1;
        font-size: 0.75rem;
        outline: none;
        background: rgba(59, 130, 246, 0.1);
        border: 1px solid #3a4652;
        width: 100%;
        max-width: 150px;
    }

    .chart-filter {
        padding: 0.3rem 0.5rem;
        border: 1px solid #3a4652;
        border-radius: 0.5rem;
        font-size: 0.75rem;
        color: #ffffff;
        cursor: pointer;
        background: rgba(59, 130, 246, 0.1);
    }

    .chart-filter.active {
        background: rgba(59, 130, 246, 0.1);
        color: #3b82f6;
        border-color: #3b82f6;
    }

    .chart-content {
        flex: 1;
        position: relative;
        width: 100%;
        min-height: 200px;
    }

    .no-data-message {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100%;
        font-size: 0.9rem;
        color: #6c757d;
        text-align: center;
    }

    canvas {
        max-width: 100%;
        max-height: 100%;
    }

    /* Line Filter Dropdown */
    .line-filter-container {
        display: flex;
        align-items: center;
        padding: 4px 14px;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        transition: transform 0.2s ease;
        border: 1px solid rgba(255, 255, 255, 0.1);
        margin-right: 10px;
    }

    .line-filter-container:hover {
        transform: translateY(-2px);
    }

    .line-filter-dropdown {
        margin-left: 12px;
        padding: 5px 13px;
        border: none;
        border-radius: 8px;
        background-color: unset;
        color: rgb(255, 255, 255);
        font-size: 0.9rem;
        font-weight: 500;
        cursor: pointer;
        transition: background-color 0.2s ease;
    }

    .line-filter-dropdown:focus {
        outline: none;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
    }

    .line-filter-container label {
        font-weight: 600;
        color: white;
        font-size: 0.95rem;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }

    /* Navbar Styling */
    .navbar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 15px;
    }

    .navbar-right {
        display: flex;
        align-items: center;
        margin-left: auto;
        gap: 15px;
    }

    .logout-btn {
        order: 2;
    }

    .navbar .line-filter-container {
        order: 1;
        position: relative;
        z-index: 10;
    }

    /* Dropdown Options */
    option {
        background: #1e293b;
        color: #ffffff;
    }

    /* Light Mode Styles */
    body.white-mode .chart-header h3 {
        color: #333333;
    }

    body.white-mode .chart-dropdown {
        background: #f1f3f5;
        color: #333333;
        border: 1px solid #cccccc;
    }

    body.white-mode .chart-filter {
        background: #f1f3f5;
        color: #333333;
        border: 1px solid #cccccc;
    }

    body.white-mode .chart-filter.active {
        background: #e9ecef;
        color: #3b82f6;
        border-color: #3b82f6;
    }

    body.white-mode .no-data-message {
        color: #666666;
    }

    body.white-mode .line-filter-container {
        background: #f1f3f5;
        border: 1px solid #cccccc;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    body.white-mode .line-filter-dropdown {
        color: #333333;
        background: transparent;
    }

    body.white-mode .line-filter-container label {
        color: #333333;
        text-shadow: none;
    }

    body.white-mode option {
        background: #ffffff;
        color: #333333;
    }

    /* Responsive Design */
    @media (max-width: 1024px) {
        .top-row, .bottom-row {
            flex-direction: column;
            height: auto;
        }
        .stats-container, .bar-graph, .pie-chart, .line-chart {
            width: 100%;
            min-height: 300px;
        }
        .stats-container {
            grid-template-columns: repeat(2, 1fr);
        }
        .chart-content {
            min-height: 250px;
        }
    }

    @media (max-width: 768px) {
        .stats-container {
            grid-template-columns: 1fr;
        }
        .chart-header {
            flex-direction: column;
            align-items: flex-start;
        }
        .chart-actions {
            width: 100%;
            justify-content: flex-start;
            margin-top: 0.5rem;
        }
        .chart-dropdown {
            width: 100%;
        }
        .bar-graph, .pie-chart, .line-chart {
            min-height: 350px;
        }
        .chart-content {
            min-height: 300px;
        }
    }

    @media (max-width: 480px) {
        .stat-card {
            padding: 0.75rem;
        }
        .stat-icon {
            width: 30px;
            height: 30px;
        }
        .stat-icon i {
            font-size: 1rem;
        }
        .stat-content h3 {
            font-size: 0.7rem;
        }
        .stat-value {
            font-size: 1rem;
        }
        .stat-change {
            font-size: 0.6rem;
        }
        .chart-header h3 {
            font-size: 0.9rem;
        }
        .chart-filter {
            font-size: 0.7rem;
            padding: 0.2rem 0.4rem;
        }
        .bar-graph, .pie-chart, .line-chart {
            min-height: 400px;
        }
        .chart-content {
            min-height: 350px;
        }
        .navbar-right {
            flex-direction: row;
            gap: 5px;
        }
        .navbar .line-filter-container {
            max-width: 120px;
        }
    }
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-datalabels/2.2.0/chartjs-plugin-datalabels.min.js"></script>
<script>
    window.onload = function () {
        setupWebSocketUpdates();
    };
// Utility function to get chart text color based on theme
function getChartTextColor() {
    return document.body.classList.contains('white-mode') ? '#333333' : '#ffffff';
}

// Utility function to update chart text colors
function updateChartTextColors(chart) {
    if (!chart) return;
    const textColor = getChartTextColor();
    if (chart.options.scales) {
        if (chart.options.scales.x) {
            chart.options.scales.x.ticks.color = textColor;
            chart.options.scales.x.grid.color = document.body.classList.contains('white-mode') ? 'rgba(0, 0, 0, 0.1)' : 'rgba(255, 255, 255, 0.1)';
        }
        if (chart.options.scales.y) {
            chart.options.scales.y.ticks.color = textColor;
            chart.options.scales.y.grid.color = document.body.classList.contains('white-mode') ? 'rgba(0, 0, 0, 0.1)' : 'rgba(255, 255, 255, 0.1)';
        }
    }
    if (chart.options.plugins.datalabels) {
        chart.options.plugins.datalabels.color = textColor;
        if (chart.options.plugins.datalabels.backgroundColor && chart.config.type === 'line') {
            chart.options.plugins.datalabels.backgroundColor = document.body.classList.contains('white-mode') ? 'rgba(52, 152, 219, 0.9)' : 'rgba(52, 152, 219, 0.7)';
        }
    }
    if (chart.options.plugins.legend && chart.options.plugins.legend.labels) {
        chart.options.plugins.legend.labels.color = textColor;
    }
    chart.update();
}

document.addEventListener('DOMContentLoaded', function() {
    // Register the Chart.js DataLabels plugin
    if (typeof ChartDataLabels !== 'undefined') {
        Chart.register(ChartDataLabels);
    } else {
        console.warn('ChartDataLabels plugin not found. Make sure to include the plugin script.');
    }

    // Parse checksheets data globally so it's available throughout the code
    window.checksheets = parseChecksheets();

    // Initialize all charts and UI components
    initializeCharts();
    setupEventListeners();
    loadInitialData();
   
    // Watch for theme changes
    const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
            if (mutation.attributeName === 'class' && mutation.target.classList.contains('white-mode')) {
                updateChartTextColors(window.barChart);
                updateChartTextColors(window.pieChart);
                updateChartTextColors(window.lineChart);
            } else if (mutation.attributeName === 'class' && !mutation.target.classList.contains('white-mode')) {
                updateChartTextColors(window.barChart);
                updateChartTextColors(window.pieChart);
                updateChartTextColors(window.lineChart);
            }
        });
    });
    observer.observe(document.body, { attributes: true });
});

function parseChecksheets() {
    try {
        return JSON.parse('{{ checksheets_data_json|safe }}');
    } catch (e) {
        console.error('Error parsing checksheets data:', e);
        return [];
    }
}

function initializeCharts() {
    configureChartDefaults();
    window.barChart = initializeBarChart();
    window.pieChart = initializePieChart();
    window.lineChart = initializeLineChart();
    setupResizeHandlers();
}

function configureChartDefaults() {
    Chart.defaults.color = getChartTextColor();
    Chart.defaults.borderColor = document.body.classList.contains('white-mode') ? 'rgba(0, 0, 0, 0.1)' : 'rgba(255, 255, 255, 0.1)';
}

function initializeBarChart() {
    const barCtx = document.getElementById('barChart');
    if (!barCtx) {
        console.warn('Bar chart canvas not found');
        return null;
    }

    return new Chart(barCtx.getContext('2d'), {
        type: 'bar',
        data: {
            labels: [],
            datasets: [{
                label: 'Count',
                data: [],
                backgroundColor: [],
                borderColor: [],
                borderWidth: 2,
                borderRadius: 5,
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            layout: {
                padding: {
                    top: window.innerWidth <= 480 ? 15 : 25
                }
            },
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        title: function(tooltipItems) {
                            const index = tooltipItems[0].dataIndex;
                            return this.chart.originalLabels ?
                                this.chart.originalLabels[index] :
                                tooltipItems[0].label;
                        }
                    }
                },
                datalabels: {
                    display: true,
                    anchor: 'end',
                    align: 'top',
                    offset: 4,
                    formatter: function(value) { return value; },
                    font: {
                        weight: 'bold',
                        size: window.innerWidth <= 480 ? 8 : 10
                    },
                    color: getChartTextColor(),
                    clamp: true
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: document.body.classList.contains('white-mode') ? 'rgba(0, 0, 0, 0.1)' : 'rgba(255, 255, 255, 0.1)'
                    },
                    ticks: {
                        color: getChartTextColor(),
                        font: { size: window.innerWidth <= 480 ? 8 : 10 },
                        stepSize: 1,
                        callback: function(value) {
                            return Number.isInteger(value) ? value : null;
                        }
                    },
                    suggestedMax: function(context) {
                        const maxValue = context.chart.data.datasets[0].data.reduce(
                            (max, value) => value > max ? value : max, 0
                        );
                        return Math.ceil(maxValue * 1.1);
                    }
                },
                x: {
                    grid: {
                        display: false
                    },
                    ticks: {
                        color: getChartTextColor(),
                        callback: function(value, index) {
                            const label = this.getLabelForValue(value);
                            return shortenLabel(label, window.innerWidth <= 480 ? 8 : 10);
                        },
                        font: { size: window.innerWidth <= 480 ? 8 : 10 }
                    }
                }
            },
            barPercentage: 0.3,
            categoryPercentage: 0.5
        }
    });
}

function initializePieChart() {
    const pieChartNoData = document.getElementById('pieChartNoData');
    const pieChartElement = document.getElementById('pieChart');

    if (!pieChartElement) {
        console.warn('Pie chart canvas not found');
        return null;
    }

    if (pieChartNoData) pieChartNoData.style.display = 'flex';
    pieChartElement.style.display = 'none';

    return new Chart(pieChartElement.getContext('2d'), {
        type: 'doughnut',
        data: {
            labels: [],
            datasets: [{
                data: [],
                backgroundColor: ['rgba(46, 204, 113, 0.7)', 'rgba(231, 76, 60, 0.7)', 'rgba(241, 196, 15, 0.7)'],
                borderColor: ['rgba(46, 204, 113, 1)', 'rgba(231, 76, 60, 1)', 'rgba(241, 196, 15, 1)'],
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '60%',
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 15,
                        boxWidth: 10,
                        color: getChartTextColor(),
                        font: { size: window.innerWidth <= 480 ? 8 : 10 }
                    }
                },
                datalabels: {
                    formatter: (value, ctx) => {
                        let sum = 0;
                        let dataArr = ctx.chart.data.datasets[0].data;
                        dataArr.forEach(data => { sum += data; });
                        let percentage = (value*100 / sum).toFixed(1)+"%";
                        return percentage;
                    },
                    color: getChartTextColor(),
                    font: {
                        weight: 'bold',
                        size: window.innerWidth <= 480 ? 8 : 10
                    }
                }
            }
        }
    });
}

function initializeLineChart() {
    const lineCtx = document.getElementById('lineChart');
    if (!lineCtx) {
        console.warn('Line chart canvas not found');
        return null;
    }

    return new Chart(lineCtx.getContext('2d'), {
        type: 'line',
        data: {
            labels: ['12:30', '12:35', '12:40', '12:45', '12:50'],
            datasets: [{
                label: 'Production live',
                data: [10, 15, 5, 85, 15],
                fill: true,
                backgroundColor: 'rgba(52, 152, 219, 0.2)',
                borderColor: 'rgba(52, 152, 219, 1)',
                tension: 0.4,
                pointBackgroundColor: 'rgba(52, 152, 219, 1)',
                pointBorderColor: '#fff',
                pointRadius: 4,
                pointHoverRadius: 6
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            layout: {
                padding: {
                    top: window.innerWidth <= 480 ? 15 : 25
                }
            },
            plugins: {
                legend: { display: false },
                datalabels: {
                    display: true,
                    align: 'top',
                    anchor: 'center',
                    offset: 7,
                    formatter: function(value) { return value; },
                    color: getChartTextColor(),
                    backgroundColor: document.body.classList.contains('white-mode') ? 'rgba(52, 152, 219, 0.9)' : 'rgba(52, 152, 219, 0.7)',
                    borderRadius: 4,
                    padding: 4,
                    font: {
                        weight: 'bold',
                        size: window.innerWidth <= 480 ? 8 : 10
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: { color: document.body.classList.contains('white-mode') ? 'rgba(0, 0, 0, 0.1)' : 'rgba(255, 255, 255, 0.1)' },
                    ticks: {
                        color: getChartTextColor(),
                        font: { size: window.innerWidth <= 480 ? 8 : 10 }
                    }
                },
                x: {
                    grid: { display: false },
                    ticks: {
                        color: getChartTextColor(),
                        font: { size: window.innerWidth <= 480 ? 8 : 10 }
                    }
                }
            }
        }
    });
}

function setupEventListeners() {
    setupFilterButtons();
    setupChecksheetSelection();
    setupLineFilter();
}

function setupFilterButtons() {
    const filterButtons = document.querySelectorAll('.chart-filter');
    filterButtons.forEach(button => {
        button.addEventListener('click', function() {
            const siblings = this.parentNode.querySelectorAll('.chart-filter');
            siblings.forEach(sibling => sibling.classList.remove('active'));
            this.classList.add('active');
            const period = this.dataset.period;
            const chartCard = this.closest('.chart-card');
            if (chartCard.querySelector('#barChart')) {
                loadChartData(period);
            } else if (chartCard.querySelector('#pieChart')) {
                const checksheetId = document.getElementById('pieChartChecksheet')?.value;
                if (checksheetId) {
                    loadPieChartData(checksheetId, period);
                }
            } else if (chartCard.querySelector('#lineChart')) {
                applyVisualEffect(chartCard);
            }
        });
    });
}

function setupChecksheetSelection() {
    const pieChartChecksheet = document.getElementById('pieChartChecksheet');
    if (!pieChartChecksheet) return;

    pieChartChecksheet.addEventListener('change', function() {
        if (this.value !== '') {
            const activePeriod = this.closest('.chart-card')
                .querySelector('.chart-filter.active')?.dataset.period || 'today';
            loadPieChartData(this.value, activePeriod);
        } else {
            const pieChartNoData = document.getElementById('pieChartNoData');
            const pieChartElement = document.getElementById('pieChart');
            if (pieChartNoData) pieChartNoData.style.display = 'flex';
            if (pieChartElement) pieChartElement.style.display = 'none';
        }
    });
}

function setupLineFilter() {
    filterChecksheetsByLine('all');
    const lineFilter = document.getElementById('lineFilter');
    if (lineFilter) {
        lineFilter.addEventListener('change', function() {
            const selectedLine = this.value;
            filterChecksheetsByLine(selectedLine);
            const activePeriod = document.querySelector('.chart-card:has(#barChart) .chart-filter.active')?.dataset.period || 'today';
            loadChartData(activePeriod, selectedLine);
        });
    }
}

function filterChecksheetsByLine(line) {
    const pieChartDropdown = document.getElementById('pieChartChecksheet');
    if (!pieChartDropdown) return;

    if (!window.checksheets || !Array.isArray(window.checksheets)) {
        console.error('Checksheets data is not available');
        return;
    }

    while (pieChartDropdown.options.length > 1) {
        pieChartDropdown.remove(1);
    }

    window.checksheets.forEach(sheet => {
        if (line === 'all' || sheet.line === line) {
            const option = document.createElement('option');
            option.value = sheet.id;
            option.text = sheet.name;
            option.dataset.line = sheet.line;
            pieChartDropdown.appendChild(option);
        }
    });

    if (pieChartDropdown.options.length > 1) {
        pieChartDropdown.value = pieChartDropdown.options[1].value;
        const activePeriod = document.querySelector('.chart-card:has(#pieChart) .chart-filter.active')?.dataset.period || 'today';
        loadPieChartData(pieChartDropdown.value, activePeriod);
    } else {
        pieChartDropdown.value = '';
        const pieChartNoData = document.getElementById('pieChartNoData');
        const pieChartElement = document.getElementById('pieChart');
        if (pieChartNoData) pieChartNoData.style.display = 'flex';
        if (pieChartElement) pieChartElement.style.display = 'none';
    }
}

function loadInitialData() {
    const lineFilter = document.getElementById('lineFilter');
    const selectedLine = lineFilter ? lineFilter.value : 'all';
    loadChartData('today', selectedLine);
    if (typeof today_yes_counts_json !== 'undefined') {
        try {
            const initialData = JSON.parse(today_yes_counts_json);
            updateBarChart(initialData);
        } catch (e) {
            console.error('Error parsing initial data:', e);
        }
    }
}

function loadChartData(period, line = 'all') {
    if (line === 'all') {
        const lineFilter = document.getElementById('lineFilter');
        if (lineFilter) {
            line = lineFilter.value;
        }
    }

    fetch(`/get_chart_data/?period=${period}&line=${line}`)
        .then(response => response.json())
        .then(data => {
            updateBarChart(data);
        })
        .catch(error => console.error('Error loading chart data:', error));
}

function loadPieChartData(checksheetId, period) {
    fetch(`/get_pie_chart_data/?checksheet_id=${checksheetId}&period=${period}`)
        .then(response => response.json())
        .then(data => {
            updatePieChart(data);
        })
        .catch(error => console.error('Error loading pie chart data:', error));
}

function updateBarChart(data) {
    if (!window.barChart) return;
    const labels = data.map(item => item.name);
    const counts = data.map(item => item.yes_count);
    window.barChart.originalLabels = [...labels];
    const backgroundColors = generateColorArray(labels.length, 0.7);
    const borderColors = generateColorArray(labels.length, 1);
    window.barChart.data.labels = labels;
    window.barChart.data.datasets[0].data = counts;
    window.barChart.data.datasets[0].backgroundColor = backgroundColors;
    window.barChart.data.datasets[0].borderColor = borderColors;
    window.barChart.options.scales.y.suggestedMax = Math.max(...counts) * 1.1;
    window.barChart.update();
}

function updatePieChart(data) {
    if (!window.pieChart) return;
    const pieChartNoData = document.getElementById('pieChartNoData');
    const pieChartElement = document.getElementById('pieChart');
    if (pieChartNoData) pieChartNoData.style.display = 'none';
    if (pieChartElement) pieChartElement.style.display = 'block';
    const fields = Object.keys(data.zone_yes_counts);
    const counts = Object.values(data.zone_yes_counts);
    const backgroundColors = generateColorArray(fields.length, 0.7);
    const borderColors = generateColorArray(fields.length, 1);
    window.pieChart.data.labels = fields;
    window.pieChart.data.datasets[0].data = counts;
    window.pieChart.data.datasets[0].backgroundColor = backgroundColors;
    window.pieChart.data.datasets[0].borderColor = borderColors;
    window.pieChart.update();
}

function setupWebSocketUpdates() {
    const protocol = window.location.protocol === "https:" ? "wss" : "ws";
    const wsUrl = `${protocol}://${window.location.host}/ws/production/`;
    console.log(`Connecting to WebSocket URL: ${wsUrl}`);

    const socket = new WebSocket(wsUrl);

    socket.onopen = function () {
        console.log("WebSocket connected");
    };

    socket.onmessage = function (event) {
        console.log("Raw WebSocket message received:", event.data);
        try {
            const data = JSON.parse(event.data);
            console.log("Parsed WebSocket data:", data);
            if (data.type === "send_production_update") {
                console.log("Processing production update with data:", data.data);
                updateDashboardElements(data.data);
            } else {
                console.log("Received non-production update message:", data);
            }
        } catch (e) {
            console.error("Error parsing WebSocket message:", e);
        }
    };

    socket.onerror = function (error) {
        console.error("WebSocket error:", error);
        setErrorState();
    };

    socket.onclose = function () {
        console.warn("WebSocket closed");
        setErrorState();
    };
}

function updateDashboardElements(data) {
    console.log("Updating dashboard elements with data:", data);
    if (!data) {
        console.warn("No data received for dashboard update");
        return;
    }
    updateElementText("production-count", data.production_count ?? "N/A");
    updateElementText("reject-count", data.total_rejects ?? "N/A");
    updateElementText("actual-production", data.actual_production ?? "N/A");
    updateElementText("efficiency-percent", data.efficiency ?? "N/A");
    if (data.connection_status) {
        updateElementText("connection-status", data.connection_status);
    }
    console.log("Dashboard elements updated");
}

function updateElementText(id, text) {
    const element = document.getElementById(id);
    if (element) {
        console.log(`Updating element ${id} with text: ${text}`);
        element.textContent = text;
    } else {
        console.warn(`Element with ID ${id} not found`);
    }
}

function setErrorState() {
    console.log("Setting error state for dashboard elements");
    updateElementText("production-count", "Error");
    updateElementText("reject-count", "Error");
    updateElementText("actual-production", "Error");
    updateElementText("efficiency-percent", "Error");
}

function setupResizeHandlers() {
    setupSidebarObserver();
    window.addEventListener('resize', resizeCharts);
}

function setupSidebarObserver() {
    const sidebarToggle = document.querySelector('.sidebar-toggle');
    if (sidebarToggle) {
        sidebarToggle.addEventListener('click', () => {
            setTimeout(resizeCharts, 300);
        });
    }
    const resizeObserver = new ResizeObserver(() => {
        setTimeout(resizeCharts, 300);
    });
    const chartsContainer = document.querySelector('.charts-container');
    if (chartsContainer) {
        resizeObserver.observe(chartsContainer);
    }
}

function resizeCharts() {
    if (window.barChart) window.barChart.resize();
    if (window.pieChart) window.pieChart.resize();
    if (window.lineChart) window.lineChart.resize();
}

function shortenLabel(label, maxLength) {
    if (!label || label.length <= maxLength) return label || '';
    return label.substring(0, maxLength - 3) + '...';
}

function generateColorArray(count, alpha) {
    return Array(count).fill().map((_, i) => {
        const hue = (i * 137) % 360;
        return `hsla(${hue}, 70%, 60%, ${alpha})`;
    });
}

function applyVisualEffect(chartCard) {
    const chartContent = chartCard.querySelector('.chart-content');
    if (chartContent) {
        chartContent.style.opacity = '0.6';
        setTimeout(() => {
            chartContent.style.opacity = '1';
        }, 300);
    }
}

// Navbar line filter integration
document.addEventListener('DOMContentLoaded', function() {
    if (document.querySelector('.dashboard')) {
        const navbar = document.querySelector('.navbar');
        if (navbar) {
            const logoutBtn = navbar.querySelector('.logout-btn');
            if (logoutBtn) {
                const navbarRight = document.createElement('div');
                navbarRight.className = 'navbar-right';
                const lineFilterContainer = document.querySelector('.line-filter-container');
                if (lineFilterContainer) {
                    const lineFilter = lineFilterContainer.cloneNode(true);
                    logoutBtn.parentNode.removeChild(logoutBtn);
                    navbarRight.appendChild(logoutBtn);
                    navbarRight.appendChild(lineFilter);
                    navbar.appendChild(navbarRight);
                    lineFilterContainer.style.display = 'none';
                    const navbarLineFilter = lineFilter.querySelector('#lineFilter');
                    const dashboardLineFilter = lineFilterContainer.querySelector('#lineFilter');
                    if (navbarLineFilter && dashboardLineFilter) {
                        navbarLineFilter.addEventListener('change', function() {
                            dashboardLineFilter.value = this.value;
                            const event = new Event('change');
                            dashboardLineFilter.dispatchEvent(event);
                        });
                    }
                }
            }
        }
    }
});
</script>

{% endblock %}