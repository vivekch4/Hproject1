{% extends 'checksheet/base.html' %}
{% load static %}
{% block extra_css %}

<link rel="stylesheet" href="{% static 'css/acknowledge.css' %}">
{% endblock %}
{% block title %}Pending Acknowledgments{% endblock %}
{% block content %}

<div class="page-container">
    <div class="header">
        <h2 class="page-title">Pending Acknowledgments</h2>
    </div>
   
    <!-- Tab Navigation -->
    <div class="tabs">
        <button id="startersheet-tab" class="tab-button active">Starter Sheets</button>
        <button id="checksheet-tab" class="tab-button">Check Sheets</button>
        <button id="form-tab" class="tab-button">Back Data</button>
    </div>

    <!-- Starter Sheet Section -->
    <div id="startersheet-section" class="tab-content active">
        <div class="search-container">
            <div class="search-input-container">
                <i class="fas fa-search search-icon"></i>
                <input type="text" id="startersheetSearch" class="search-input" placeholder="Search by starter sheet name or username...">
            </div>
            <div class="filter-options">
                <span class="filter-label">Filter by shift:</span>
                <select id="startersheetShiftFilter" class="filter-select">
                    <option value="">All Shifts</option>
                    <option value="A">Shift A</option>
                    <option value="B">Shift B</option>
                </select>
            </div>
        </div>
       
        <div class="table-responsive">
            <table class="checksheets-container">
                <thead>
                    <tr>
                        <th class="sortable" data-sort="name">Starter Sheet Name <i class="fas fa-sort"></i></th>
                        <th class="sortable" data-sort="Line">Line <i class="fas fa-sort"></i></th>
                        <th class="sortable" data-sort="username">Username <i class="fas fa-sort"></i></th>
                        <th class="sortable" data-sort="shift">Shift <i class="fas fa-sort"></i></th>
                        <th>Acknowledgment</th>
                        <th>Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="startersheetTableBody">
                    {% for entry in pending_acknowledgments %}
                    <tr>
                        <td>{{ entry.startersheet__name }}</td>
                        <td>{{ entry.line }}</td>
                        <td>{{ entry.filled_by__username }}</td>
                        <td>
                            {% if entry.shift == "A" %}
                                <span class="shift-badge shift-a">Shift A</span>
                            {% elif entry.shift == "B" %}
                                <span class="shift-badge shift-b">Shift B</span>
                            {% elif entry.shift == "C" %}
                                <span class="shift-badge shift-c">Shift C</span>
                            {% endif %}
                        </td>
                        <td>
                           
                            <span class="status-pending">{{ entry.approval_status }}</span>
                       
           
                        </td>
                        <td>{{ entry.timestamp|date:"Y-m-d" }}</td>
                       
                        <td>
                            <a href="{% url 'view_filled_startersheet' entry.startersheet__id entry.filled_by__id entry.shift entry.id|default:0 %}" class="view-button">
                                <i class="fas fa-eye"></i> view
                            </a>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="5" class="empty-text">No pending starter sheet acknowledgments</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            <div class="pagination" id="startersheetPagination">
                <div class="pagination-info">
                    <span>Total Pending: {{ pending_acknowledgments|length }}</span>
                </div>
                <div class="pagination-controls">
                    <button class="pagination-button" id="startersheetPrev" disabled>Previous</button>
                    <div class="pagination-numbers" id="startersheetPageNumbers"></div>
                    <button class="pagination-button" id="startersheetNext">Next</button>
                </div>
            </div>
           
        </div>
    </div>

    <!-- Back Data Section -->
    <div id="form-section" class="tab-content">
        <div class="search-container">
            <div class="search-input-container">
                <i class="fas fa-search search-icon"></i>
                <input type="text" id="backDataSearch" class="search-input" placeholder="Search by checksheet name or reason...">
            </div>
            <div class="filter-options">
                <span class="filter-label">Filter by shift:</span>
                <select id="backDataShiftFilter" class="filter-select">
                    <option value="">All Shifts</option>
                    <option value="A">Shift A</option>
                    <option value="B">Shift B</option>
                    <option value="C">Shift C</option>
                </select>
            </div>
        </div>
       
        <div class="table-responsive">
            <table class="checksheets-container">
                <thead>
                    <tr>
                        <th class="sortable" data-sort="name">CheckSheet <i class="fas fa-sort"></i></th>
                        <th class="sortable" data-sort="shift">Shift <i class="fas fa-sort"></i></th>
                        <th class="sortable" data-sort="date">Date <i class="fas fa-sort"></i></th>
                        <th class="sortable" data-sort="reason">Reason <i class="fas fa-sort"></i></th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="backDataTableBody">
                    {% for request in pending_requests %}
                    <tr>
                        <td>{{ request.checksheet.name }}</td>
                        <td>
                            {% if request.shift == "A" %}
                                <span class="shift-badge shift-a">Shift A</span>
                            {% elif request.shift == "B" %}
                                <span class="shift-badge shift-b">Shift B</span>
                            {% elif request.shift == "C" %}
                                <span class="shift-badge shift-c">Shift C</span>
                            {% endif %}
                        </td>
                        <td>{{ request.date }}</td>
                        <td>{{ request.reason }}</td>
                        <td><span class="status-pending">Pending</span></td>
                        <td>
                            <div class="action-buttons">
                                <a href="{% url 'accept_request' request.id %}" class="accept-button">
                                    <i class="fas fa-check"></i> Accept
                                </a>
                                <a href="{% url 'reject_request' request.id %}" class="reject-button">
                                    <i class="fas fa-times"></i> Reject
                                </a>
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="6" class="empty-text">No pending form requests</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            <div class="pagination" id="backDataPagination">
                <div class="pagination-info">
                    <span>Total Pending: {{ pending_requests|length }}</span>
                </div>
                <div class="pagination-controls">
                    <button class="pagination-button" id="backDataPrev" disabled>Previous</button>
                    <div class="pagination-numbers" id="backDataPageNumbers"></div>
                    <button class="pagination-button" id="backDataNext">Next</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Check Sheet Section -->
    <div id="checksheet-section" class="tab-content">
        <div class="search-container">
            <div class="search-input-container">
                <i class="fas fa-search search-icon"></i>
                <input type="text" id="checksheetSearch" class="search-input" placeholder="Search by checksheet name or username...">
            </div>
            <div class="filter-options">
                <span class="filter-label">Filter by shift:</span>
                <select id="checksheetShiftFilter" class="filter-select">
                    <option value="">All Shifts</option>
                    <option value="A">Shift A</option>
                    <option value="B">Shift B</option>
                    <option value="C">Shift C</option>
                </select>
            </div>

            {% if pending_acknowledgments_checksheet %}
                    <div class="action-buttons-top">
                        <button type="submit" name="action" value="accept" class="accept-button">
                            <i class="fas fa-check"></i> Accept
                        </button>
                        <button type="submit" name="action" value="reject" class="reject-button">
                            <i class="fas fa-times"></i> Reject
                        </button>
                    </div>
                    {% endif %}
           
        </div>
       
        <div class="table-responsive">
            <form method="POST" action="{% url 'acknowledge_checksheets' %}" id="checksheet-form">
                {% csrf_token %}
                <input type="hidden" name="shift" value="{{ request.GET.shift }}">
                <input type="hidden" name="selected_date" value="{{ request.GET.selected_date }}">
                <input type="hidden" name="active_tab" value="checksheet">
   
            <table class="checksheets-container">
                <thead>
                    <tr>
                       
                    <th>
                        <input type="checkbox" id="select-all" class="checkbox">
                    </th>
                        <th class="sortable" data-sort="name">Checksheet Name <i class="fas fa-sort"></i></th>
                        <th class="sortable" data-sort="line">Line <i class="fas fa-sort"></i></th>
                        <th class="sortable" data-sort="username">User <i class="fas fa-sort"></i></th>
                        <th class="sortable" data-sort="shift">Shift <i class="fas fa-sort"></i></th>
                        <th>Status</th>
                        <th>Date</th>
                        <th>Zone Data</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="checksheetTableBody">
                    {% for entry in pending_acknowledgments_checksheet %}
                    <tr>
                        <td>
                            <input type="checkbox" name="selected_checksheets" value="{{ entry.checksheet_name }}|{{ entry.username }}|{{ entry.shift }}|{{ entry.date }}" class="checkbox">
                        </td>
                        <td>{{ entry.checksheet_name }}</td>
                        <td>{{ entry.line }}</td>
                        <td>{{ entry.username }}</td>
                        <td>
                            <span class="shift-badge shift-{{ entry.shift|lower }}">
                                Shift {{ entry.shift }}
                            </span>
                        </td>
                        <td><span class="status-pending">{{ entry.acknowledgment }}</span></td>
                        <td>{{ entry.date }}</td>
                        <td>
                            <div class="zone-data" data-status="{{ entry.status_data }}"></div>
                        </td>
                        <td>
                            <button type="button" class="view-button1" data-name="{{ entry.checksheet_name }}" data-line="{{ entry.line }}" data-user="{{ entry.username }}"
                                data-shift="{{ entry.shift }}" data-date="{{ entry.date }}" data-zone="{{ entry.status_data }}" data-empid="{{ entry.employee_id }}">
                            <i class="fas fa-eye"></i> View
                        </button>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="5" class="empty-text">No pending check sheet acknowledgments</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
       
            <div class="pagination" id="checksheetPagination">
                <div class="pagination-info">
                    <span>Total Pending: {{ pending_acknowledgments_checksheet|length }}</span>
                </div>
                <div class="pagination-controls">
                    <button class="pagination-button" id="checksheetPrev" disabled>Previous</button>
                    <div class="pagination-numbers" id="checksheetPageNumbers"></div>
                    <button class="pagination-button" id="checksheetNext">Next</button>
                </div>
            </div>
           
        </div>
    </form>
    </div>
</div>
<!-- Update your rejection modal form -->
<div id="rejection-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h3>Rejection Reason</h3>
        <form id="rejection-form" method="post" action="{% url 'acknowledge_checksheets' %}">
            {% csrf_token %}
            <input type="hidden" name="selected_checksheets" id="rejection-checksheets" value="">
            <input type="hidden" name="shift" value="{{ request.GET.shift }}">
            <input type="hidden" name="selected_date" value="{{ request.GET.selected_date }}">
            <input type="hidden" name="active_tab" value="checksheet">
            <input type="hidden" name="action" value="reject">
           
            <div class="form-group">
                <label for="rejection-reason">Please provide a reason for rejection:</label>
                <textarea id="rejection-reason" name="rejection_reason" rows="4" required></textarea>
            </div>
           
            <div class="form-actions">
                <button type="button" class="cancel-button">Cancel</button>
                <button type="submit" class="submit-button">Submit Rejection</button>
            </div>
        </form>
    </div>
</div>

  <!-- Modified Modal HTML Structure -->
  <div id="checksheetModal" class="modal">
    <div class="modal-content">
        <span class="close1">Ã—</span>
       
        <!-- Checksheet Header with Name and Images -->
        <div class="checksheet-header">
            <div class="checksheet-title-container">
                <span id="modal-checksheet" class="checksheet-name"></span>
            </div>
            <!-- Images will be placed here -->
            <div id="image-container" class="checksheet-images-row">
                <div class="loading">Loading images...</div>
            </div>
        </div>
       
        <!-- User Details in a single row -->
        <div class="user-details-row">
            <div class="detail-item">
                <span class="detail-label">User:</span>
                <span id="modal-user" class="detail-value"></span>
            </div>
            <div class="detail-item">
                <span class="detail-label">Emp ID:</span>
                <span id="modal-emid" class="detail-value"></span>
            </div>
            <div class="detail-item">
                <span class="detail-label">Shift:</span>
                <span id="modal-shift" class="detail-value"></span>
            </div>
            <div class="detail-item">
                <span class="detail-label">Date:</span>
                <span id="modal-date" class="detail-value"></span>
            </div>
        </div>
       
        <h3>Zone Data Summary</h3>
        <div id="modal-zone-data">
            <table class="approval-hierarchy-table">
                <thead>
                    <tr>
                        {% comment %} <th>Zone</th>
                        <th>Data</th> {% endcomment %}
                    </tr>
                </thead>
                <tbody id="zone-data-body"></tbody>
            </table>
        </div>
    </div>
</div>

<!-- JavaScript -->
<script>

// Pagination settings
const rowsPerPage = 5;

// Function to setup pagination for a table
function setupPagination(tableBodyId, paginationId, prevButtonId, nextButtonId, pageNumbersId) {
    const tableBody = document.getElementById(tableBodyId);
    const pagination = document.getElementById(paginationId);
    const prevButton = document.getElementById(prevButtonId);
    const nextButton = document.getElementById(nextButtonId);
    const pageNumbers = document.getElementById(pageNumbersId);
    let currentPage = 1;
    let allRows = Array.from(tableBody.querySelectorAll('tr'));

    // Function to update displayed rows
    function updateTable() {
        // Filter rows based on current filters
        const searchInput = document.getElementById(tableBodyId.replace('TableBody', 'Search'));
        const shiftFilter = document.getElementById(tableBodyId.replace('TableBody', 'ShiftFilter'));
        const searchTerm = searchInput ? searchInput.value.toLowerCase().trim() : '';
        const shiftValue = shiftFilter ? shiftFilter.value : '';

        const filteredRows = allRows.filter(row => {
            const name = row.querySelector('td:first-child').textContent.toLowerCase();
            const username = row.querySelector('td:nth-child(3)')?.textContent.toLowerCase() || '';
            const shift = row.querySelector('.shift-badge')?.textContent || '';
            const reason = row.querySelector('td:nth-child(4)')?.textContent.toLowerCase() || '';

            const matchesSearch = searchTerm === '' || name.includes(searchTerm) || username.includes(searchTerm) || reason.includes(searchTerm);
            const matchesShift = shiftValue === '' || shift.includes(shiftValue);
            return matchesSearch && matchesShift;
        });

        // Calculate pagination
        const totalRows = filteredRows.length;
        const totalPages = Math.ceil(totalRows / rowsPerPage);
        currentPage = Math.min(currentPage, totalPages || 1);

        // Hide all rows
        allRows.forEach(row => row.style.display = 'none');

        // Show rows for current page
        const start = (currentPage - 1) * rowsPerPage;
        const end = start + rowsPerPage;
        filteredRows.slice(start, end).forEach(row => row.style.display = '');

        // Update pagination controls
        updatePaginationControls(totalPages, filteredRows.length);
    }

    // Function to update pagination controls
    function updatePaginationControls(totalPages, totalFilteredRows) {
        // Update buttons
        prevButton.disabled = currentPage === 1;
        nextButton.disabled = currentPage === totalPages || totalPages === 0;

        // Update page numbers
        pageNumbers.innerHTML = '';
        for (let i = 1; i <= totalPages; i++) {
            const pageNum = document.createElement('span');
            pageNum.className = 'page-number';
            if (i === currentPage) pageNum.classList.add('active');
            pageNum.textContent = i;
            pageNum.addEventListener('click', () => {
                currentPage = i;
                updateTable();
            });
            pageNumbers.appendChild(pageNum);
        }
       
        // Update total count in pagination info
        const paginationInfo = pagination.querySelector('.pagination-info span');
        if (paginationInfo) {
            paginationInfo.textContent = `Total Pending: ${totalFilteredRows}`;
        }
    }

    // Event listeners for navigation
    prevButton.addEventListener('click', () => {
        if (currentPage > 1) {
            currentPage--;
            updateTable();
        }
    });

    nextButton.addEventListener('click', () => {
        const searchInput = document.getElementById(tableBodyId.replace('TableBody', 'Search'));
        const shiftFilter = document.getElementById(tableBodyId.replace('TableBody', 'ShiftFilter'));
        const searchTerm = searchInput ? searchInput.value.toLowerCase().trim() : '';
        const shiftValue = shiftFilter ? shiftFilter.value : '';

        // Get filtered rows for pagination calculation
        const filteredRows = allRows.filter(row => {
            const name = row.querySelector('td:first-child').textContent.toLowerCase();
            const username = row.querySelector('td:nth-child(3)')?.textContent.toLowerCase() || '';
            const shift = row.querySelector('.shift-badge')?.textContent || '';
            const reason = row.querySelector('td:nth-child(4)')?.textContent.toLowerCase() || '';

            const matchesSearch = searchTerm === '' || name.includes(searchTerm) || username.includes(searchTerm) || reason.includes(searchTerm);
            const matchesShift = shiftValue === '' || shift.includes(shiftValue);
            return matchesSearch && matchesShift;
        });

        const totalPages = Math.ceil(filteredRows.length / rowsPerPage);
        if (currentPage < totalPages) {
            currentPage++;
            updateTable();
        }
    });

    // Update table on search or filter change
    const searchInput = document.getElementById(tableBodyId.replace('TableBody', 'Search'));
    const shiftFilter = document.getElementById(tableBodyId.replace('TableBody', 'ShiftFilter'));
   
    if (searchInput) {
        searchInput.addEventListener('input', () => {
            currentPage = 1;
            updateTable();
        });
    }
   
    if (shiftFilter) {
        shiftFilter.addEventListener('change', () => {
            currentPage = 1;
            updateTable();
        });
    }

    // Initial update
    updateTable();
   
    // Return the updateTable function so it can be called from outside
    return updateTable;
}

// Setup pagination for each table and store the update functions
const startersheetUpdate = setupPagination('startersheetTableBody', 'startersheetPagination', 'startersheetPrev', 'startersheetNext', 'startersheetPageNumbers');
const checksheetUpdate = setupPagination('checksheetTableBody', 'checksheetPagination', 'checksheetPrev', 'checksheetNext', 'checksheetPageNumbers');
const backDataUpdate = setupPagination('backDataTableBody', 'backDataPagination', 'backDataPrev', 'backDataNext', 'backDataPageNumbers');

// Main JavaScript for the page
document.addEventListener('DOMContentLoaded', function() {
    // --- MODAL HANDLING ---
   
    // Rejection Modal
    var rejectionModal = document.getElementById('rejection-modal');
    var closeRejectionModalButton = rejectionModal.querySelector('.close');
    var cancelButton = rejectionModal.querySelector('.cancel-button');
   
    // Function to open rejection modal and populate hidden field
    function openRejectionModal() {
        // Get all selected checksheets
        var selectedCheckboxes = document.querySelectorAll('input[name="selected_checksheets"]:checked');
       
        if (selectedCheckboxes.length === 0) {
            alert('Please select at least one checksheet to reject.');
            return;
        }
       
        // Create an array of selected values
        var selectedValues = Array.from(selectedCheckboxes).map(function(checkbox) {
            return checkbox.value;
        });
       
        // Populate the hidden input with selected checksheets
        document.getElementById('rejection-checksheets').value = selectedValues.join(',');
       
        // Show the modal
        rejectionModal.style.display = 'block';
    }
   
    // Function to close rejection modal
    function closeRejectionModal() {
        rejectionModal.style.display = 'none';
        document.getElementById('rejection-reason').value = '';
    }
   
    // Regular Rejection Button Event (the one inside the form)
    var formRejectButton = document.querySelector('form .reject-button');
    if (formRejectButton) {
        formRejectButton.addEventListener('click', function(e) {
            e.preventDefault();
            openRejectionModal();
        });
    }
   
    // Close modal buttons
    closeRejectionModalButton.addEventListener('click', closeRejectionModal);
    cancelButton.addEventListener('click', closeRejectionModal);
   
    // Close modal if clicking outside
    window.addEventListener('click', function(e) {
        if (e.target === rejectionModal) {
            closeRejectionModal();
        }
    });
   
    // --- CHECKSHEET MODAL HANDLING ---
   
    const checksheetModal = document.getElementById('checksheetModal');
    const closeBtn = document.querySelector('.close1');
   
    // Close the modal when clicking the X
    closeBtn.onclick = function() {
        checksheetModal.style.display = "none";
    }
   
    // Close the modal when clicking outside of it
    window.onclick = function(event) {
        if (event.target == checksheetModal) {
            checksheetModal.style.display = "none";
        }
        // The rejection modal is handled separately
    }
   
    // --- VIEW BUTTON HANDLING ---
   
    // Add click event to all view buttons
    document.querySelectorAll('.view-button1').forEach(button => {
        button.addEventListener('click', function() {
            // Get data from button attributes
            const name = this.getAttribute('data-name');
            const line = this.getAttribute('data-line');
            const user = this.getAttribute('data-user');
            const idis = this.getAttribute('data-empid');
            const shift = this.getAttribute('data-shift');
            const date = this.getAttribute('data-date');
            const zoneData = this.getAttribute('data-zone');
           
            // Populate modal with data
            document.getElementById('modal-checksheet').textContent = name;
            document.getElementById('modal-user').textContent = user;
            document.getElementById('modal-emid').textContent = idis;
            document.getElementById('modal-shift').textContent = shift;
            document.getElementById('modal-date').textContent = date;
           
            // Populate zone data table with the transformed data
            const zoneBody = document.getElementById('zone-data-body');
            zoneBody.innerHTML = '';
           
            if (zoneData) {
                // Check if the data is in the old format (with : separator)
                if (zoneData.includes(':')) {
                    // Handle the old format (key:value pairs separated by commas)
                    const items = zoneData.split(', ');
                   
                    // First create a table with headers
                    const headerRow = document.createElement('tr');
                    const dataRow = document.createElement('tr');
                   
                    items.forEach(item => {
                        if (item.includes(':')) {
                            const [key, value] = item.split(':').map(part => part.trim());
                           
                            // Create header cell
                            const th = document.createElement('th');
                            th.textContent = key;
                            headerRow.appendChild(th);
                           
                            // Create data cell
                            const td = document.createElement('td');
                            td.textContent = value;
                            dataRow.appendChild(td);
                        }
                    });
                   
                    // Append rows to zone data body
                    zoneBody.appendChild(headerRow);
                    zoneBody.appendChild(dataRow);
                } else {
                    // Handle the new format (raw vertical data)
                    const transformedTable = transformZoneData(zoneData);
                    zoneBody.appendChild(transformedTable);
                }
            } else {
                zoneBody.innerHTML = '<tr><td colspan="2">No zone data available</td></tr>';
            }
           
            // Load images for this checksheet
            loadChecksheetImages(name, line);
           
            // Fetch approval hierarchy data
            fetchApprovalHierarchy(name, user, shift, date, line);
           
            // Show the modal
            checksheetModal.style.display = "block";
        });
    });

    // --- APPROVAL HIERARCHY HANDLING ---
   
    function fetchApprovalHierarchy(checksheetName, username, shift, date, line) {
        // Create a URL with parameters - now including line
        const url = `/get_checksheet_approval_hierarchy/?name=${encodeURIComponent(checksheetName)}&username=${encodeURIComponent(username)}&shift=${encodeURIComponent(shift)}&date=${encodeURIComponent(date)}&line=${encodeURIComponent(line)}`;
       
        // Create a container for the hierarchy if it doesn't exist
        if (!document.getElementById('approval-hierarchy-container')) {
            const hierarchyContainer = document.createElement('div');
            hierarchyContainer.id = 'approval-hierarchy-container';
            hierarchyContainer.className = 'approval-hierarchy-section';
           
            // Add after zone data container
            document.getElementById('modal-zone-data').parentNode.appendChild(hierarchyContainer);
        }
       
        const hierarchyContainer = document.getElementById('approval-hierarchy-container');
        hierarchyContainer.innerHTML = '<div class="loading">Loading approval hierarchy...</div>';
       
        // Fetch the hierarchy data
        fetch(url)
            .then(response => response.json())
            .then(data => {
                renderApprovalHierarchy(data, hierarchyContainer);
            })
            .catch(error => {
                console.error('Error loading approval hierarchy:', error);
                hierarchyContainer.innerHTML = '<p>Error loading approval hierarchy. Please try again.</p>';
            });
    }
   
    // Function to render approval hierarchy
    function renderApprovalHierarchy(data, container) {
        // Create the heading and table structure
        let html = `
            <h3>Approval Hierarchy</h3>
            <div class="table-responsive">
                <table class="approval-hierarchy-table">
                    <thead>
                        <tr>
                            <th>Level</th>
                            <th>Assigned To</th>
                            <th>Status</th>
                            <th>Action By</th>
                            <th>Timestamp</th>
                            <th>Rejection Reason</th>
                        </tr>
                    </thead>
                    <tbody>
        `;
       
        // Check if we have hierarchy data
        if (data.approval_hierarchy) {
            const hierarchy = data.approval_hierarchy;
            const rejection = data.rejection_info;
           
            // Level 1
            if (hierarchy.level1) {
                html += renderHierarchyRow('Level 1', hierarchy.level1, rejection);
            }
           
            // Level 2
            if (hierarchy.level2) {
                html += renderHierarchyRow('Level 2', hierarchy.level2, rejection);
            }
           
            // Level 3
            if (hierarchy.level3) {
                html += renderHierarchyRow('Level 3', hierarchy.level3, rejection);
            }
        } else {
            html += `<tr><td colspan="6">No approval hierarchy information available</td></tr>`;
        }
       
        html += `
                    </tbody>
                </table>
            </div>
        `;
       
        container.innerHTML = html;
    }
   
    // Helper function to render a hierarchy row
    function renderHierarchyRow(levelLabel, levelData, rejectionInfo) {
        // Set status class based on status value
        let statusClass = 'status-pending';
        if (levelData.status === 'Approved') {
            statusClass = 'status-accepted';
        } else if (levelData.status === 'Rejected') {
            statusClass = 'status-rejected';
        }
       
        // Format timestamp if present
        const timestamp = levelData.timestamp ? new Date(levelData.timestamp).toLocaleString() : '-';
       
        // Show rejection reason if this level is rejected
        let rejectionReason = '-';
        if (levelData.status === 'Rejected' && rejectionInfo) {
            rejectionReason = rejectionInfo.reason || '-';
        }
       
        return `
        <tr>
            <td>${levelLabel}</td>
            <td>${levelData.assigned_to}</td>
            <td>
                <span class="status-badge ${statusClass}">${levelData.status}</span>
            </td>
            <td>${levelData.action_by || '-'}</td>
            <td>${timestamp}</td>
            <td>${rejectionReason}</td>
        </tr>
        `;
    }
   
    // --- IMAGE HANDLING ---
   
    // Function to load images
    function loadChecksheetImages(checksheetName, line) {
        const imageContainer = document.getElementById('image-container');
       
        imageContainer.innerHTML = '<div class="loading">Loading images...</div>';
       
        // Fetch images using AJAX - now passing both name and line
        fetch(`/get_checksheet_images/?name=${encodeURIComponent(checksheetName)}&line=${encodeURIComponent(line)}`)
            .then(response => response.json())
            .then(data => {
                imageContainer.innerHTML = '';
               
                if (data.images && data.images.length > 0) {
                    // Add all images to the horizontal gallery
                    data.images.forEach(image => {
                        const imgElement = document.createElement('img');
                        imgElement.src = image.url;
                        imgElement.alt = 'Checksheet Image';
                        imgElement.className = 'checksheet-image';
                       
                        imageContainer.appendChild(imgElement);
                    });
                } else {
                    imageContainer.innerHTML = '<p>No images available for this checksheet.</p>';
                }
            })
            .catch(error => {
                console.error('Error loading images:', error);
                imageContainer.innerHTML = '<p>Error loading images. Please try again.</p>';
            });
    }
   
    // --- TAB HANDLING ---
   
    const starterSheetTab = document.getElementById('startersheet-tab');
    const checkSheetTab = document.getElementById('checksheet-tab');
    const formTab = document.getElementById('form-tab');
    const starterSheetSection = document.getElementById('startersheet-section');
    const checkSheetSection = document.getElementById('checksheet-section');
    const formSection = document.getElementById('form-section');

    // Function to set the active tab
    function setActiveTab(tab) {
        sessionStorage.setItem('activeTab', tab);
        starterSheetTab.classList.remove('active');
        checkSheetTab.classList.remove('active');
        formTab.classList.remove('active');
        starterSheetSection.classList.remove('active');
        checkSheetSection.classList.remove('active');
        formSection.classList.remove('active');

        if (tab === 'startersheet') {
            starterSheetTab.classList.add('active');
            starterSheetSection.classList.add('active');
            // Update pagination for starter sheet tab
            startersheetUpdate();
        } else if (tab === 'checksheet') {
            checkSheetTab.classList.add('active');
            checkSheetSection.classList.add('active');
            // Update pagination for check sheet tab
            checksheetUpdate();
        } else if (tab === 'form') {
            formTab.classList.add('active');
            formSection.classList.add('active');
            // Update pagination for form tab
            backDataUpdate();
        }
    }

    // Tab switching event handlers
    starterSheetTab.addEventListener('click', function() {
        setActiveTab('startersheet');
    });

    checkSheetTab.addEventListener('click', function() {
        setActiveTab('checksheet');
    });

    formTab.addEventListener('click', function() {
        setActiveTab('form');
    });

    // Load active tab from sessionStorage
    const activeTab = sessionStorage.getItem('activeTab');
    if (activeTab === 'checksheet') {
        checkSheetTab.click();
    } else if (activeTab === 'form') {
        formTab.click();
    } else {
        starterSheetTab.click();
    }
   
    // --- CHECKBOX HANDLING ---
   
    const selectAll = document.getElementById('select-all');
    if (selectAll) {
        selectAll.addEventListener('change', function() {
            const checkboxes = document.querySelectorAll("input[name='selected_checksheets']");
            checkboxes.forEach(cb => cb.checked = this.checked);
        });
    }

    // --- FORMAT STATUS DATA ---
   
    // Format status data cells
    const statusCells = document.querySelectorAll('.zone-data[data-status]');
    statusCells.forEach(cell => {
        const statusText = cell.getAttribute('data-status');
        if (statusText) {
            const items = statusText.split(', ');
            items.forEach(item => {
                if (item.includes(':')) {
                    const [key, value] = item.split(':').map(part => part.trim());
                    const itemElement = document.createElement('span');
                    itemElement.className = 'zone-item';
                    itemElement.textContent = `${key} : ${value}`;
                    cell.appendChild(itemElement);
                }
            });
        }
    });

    // --- SEARCH AND FILTER FUNCTIONS ---
   
    // We've replaced these with the pagination approach above
    // The old search-only functions are now integrated into the pagination system
   
    // --- SORTING FUNCTIONALITY ---
   
    document.querySelectorAll('.sortable').forEach(header => {
        header.addEventListener('click', function() {
            const table = this.closest('table');
            const tbody = table.querySelector('tbody');
            const tableId = tbody.id;
            const rows = Array.from(tbody.querySelectorAll('tr'));
            const column = this.dataset.sort;
            const direction = this.classList.contains('asc') ? 'desc' : 'asc';
           
            // Reset all sort icons
            table.querySelectorAll('.sortable i').forEach(icon => {
                icon.className = 'fas fa-sort';
            });
           
            // Update current sort icon
            this.querySelector('i').className = `fas fa-sort-${direction === 'asc' ? 'up' : 'down'}`;
           
            // Sort rows
            rows.sort((a, b) => {
                let aValue, bValue;
               
                if (tableId === 'checksheetTableBody') {
                    switch(column) {
                        case 'name':
                            aValue = a.querySelector('td:nth-child(2)').textContent;
                            bValue = b.querySelector('td:nth-child(2)').textContent;
                            break;
                        case 'line':
                            aValue = a.querySelector('td:nth-child(3)').textContent;
                            bValue = b.querySelector('td:nth-child(3)').textContent;
                            break;
                        case 'username':
                            aValue = a.querySelector('td:nth-child(4)').textContent;
                            bValue = b.querySelector('td:nth-child(4)').textContent;
                            break;
                        case 'shift':
                            aValue = a.querySelector('.shift-badge').textContent;
                            bValue = b.querySelector('.shift-badge').textContent;
                            break;
                    }
                } else if (tableId === 'startersheetTableBody') {
                    switch(column) {
                        case 'name':
                            aValue = a.querySelector('td:first-child').textContent;
                            bValue = b.querySelector('td:first-child').textContent;
                            break;
                        case 'Line':
                            aValue = a.querySelector('td:nth-child(2)').textContent;
                            bValue = b.querySelector('td:nth-child(2)').textContent;
                            break;
                        case 'username':
                            aValue = a.querySelector('td:nth-child(3)').textContent;
                            bValue = b.querySelector('td:nth-child(3)').textContent;
                            break;
                        case 'shift':
                            aValue = a.querySelector('.shift-badge').textContent;
                            bValue = b.querySelector('.shift-badge').textContent;
                            break;
                    }
                } else if (tableId === 'backDataTableBody') {
                    switch(column) {
                        case 'name':
                            aValue = a.querySelector('td:first-child').textContent;
                            bValue = b.querySelector('td:first-child').textContent;
                            break;
                        case 'shift':
                            aValue = a.querySelector('.shift-badge').textContent;
                            bValue = b.querySelector('.shift-badge').textContent;
                            break;
                        case 'date':
                            aValue = new Date(a.querySelector('td:nth-child(3)').textContent);
                            bValue = new Date(b.querySelector('td:nth-child(3)').textContent);
                            return direction === 'asc' ? aValue - bValue : bValue - aValue;
                        case 'reason':
                            aValue = a.querySelector('td:nth-child(4)').textContent;
                            bValue = b.querySelector('td:nth-child(4)').textContent;
                            break;
                    }
                }
               
                if (column === 'date') {
                    return direction === 'asc' ? aValue - bValue : bValue - aValue;
                }
               
                if (direction === 'asc') {
                    return aValue.localeCompare(bValue);
                } else {
                    return bValue.localeCompare(aValue);
                }
            });
           
            // Reorder rows
            rows.forEach(row => tbody.appendChild(row));
           
            // Update sort direction
            this.classList.toggle('asc');
           
            // After sorting, update the correct pagination
            if (tableId === 'startersheetTableBody') {
                startersheetUpdate();
            } else if (tableId === 'checksheetTableBody') {
                checksheetUpdate();
            } else if (tableId === 'backDataTableBody') {
                backDataUpdate();
            }
        });
    });
   
    // --- EXTERNAL BUTTONS FUNCTIONALITY ---
   
    // Get references to the external buttons and the form
    const externalAcceptButton = document.querySelector('.action-buttons-top .accept-button');
    const externalRejectButton = document.querySelector('.action-buttons-top .reject-button');
    const checksheetForm = document.getElementById('checksheet-form');
   
    // Function to handle external accept button click
    if (externalAcceptButton) {
        externalAcceptButton.addEventListener('click', function(e) {
            e.preventDefault();
           
            // Check if any checkboxes are selected
            const selectedCheckboxes = document.querySelectorAll('input[name="selected_checksheets"]:checked');
            if (selectedCheckboxes.length === 0) {
                alert('Please select at least one checksheet to accept.');
                return;
            }
           
            // Create a hidden input for the action if it doesn't exist
            let actionInput = checksheetForm.querySelector('input[name="action"]');
            if (!actionInput) {
                actionInput = document.createElement('input');
                actionInput.type = 'hidden';
                actionInput.name = 'action';
                checksheetForm.appendChild(actionInput);
            }
           
            // Set the action value to accept
            actionInput.value = 'accept';
           
            // Submit the form
            checksheetForm.submit();
        });
    }
   
    // Function to handle external reject button click
    if (externalRejectButton) {
        externalRejectButton.addEventListener('click', function(e) {
            e.preventDefault();
           
            // Check if any checkboxes are selected
            const selectedCheckboxes = document.querySelectorAll('input[name="selected_checksheets"]:checked');
            if (selectedCheckboxes.length === 0) {
                alert('Please select at least one checksheet to reject.');
                return;
            }
           
            // Open rejection modal
            openRejectionModal();
        });
    }
   
    // Helper function for zone data transformation
    function transformZoneData(zoneData) {
        // If this function is not implemented in your code, add a placeholder
        // or implement it based on your requirements
        const fragment = document.createDocumentFragment();
        const row = document.createElement('tr');
        const cell = document.createElement('td');
        cell.colSpan = 2;
        cell.textContent = "Zone data format not supported";
        row.appendChild(cell);
        fragment.appendChild(row);
        return fragment;
    }
});
</script>
{% endblock %}